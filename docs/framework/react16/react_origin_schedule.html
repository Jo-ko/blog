<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React源码-schedule | 小丑不哭</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="一只前端哈狗的开发日常">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.bb8e4b6a.css" as="style"><link rel="preload" href="/blog/assets/js/app.bc936f00.js" as="script"><link rel="preload" href="/blog/assets/js/4.2ccc4457.js" as="script"><link rel="preload" href="/blog/assets/js/1.3d4d4d28.js" as="script"><link rel="preload" href="/blog/assets/js/51.912e8db1.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.21421b3f.js"><link rel="prefetch" href="/blog/assets/js/11.465a3643.js"><link rel="prefetch" href="/blog/assets/js/12.5c15b4a0.js"><link rel="prefetch" href="/blog/assets/js/13.ef2df33e.js"><link rel="prefetch" href="/blog/assets/js/14.24545c08.js"><link rel="prefetch" href="/blog/assets/js/15.b64d08f3.js"><link rel="prefetch" href="/blog/assets/js/16.cd815414.js"><link rel="prefetch" href="/blog/assets/js/17.75ba5f7b.js"><link rel="prefetch" href="/blog/assets/js/18.a941584d.js"><link rel="prefetch" href="/blog/assets/js/19.774fbcfa.js"><link rel="prefetch" href="/blog/assets/js/20.984ca59d.js"><link rel="prefetch" href="/blog/assets/js/21.1e47c01c.js"><link rel="prefetch" href="/blog/assets/js/22.4ad9767a.js"><link rel="prefetch" href="/blog/assets/js/23.80a02068.js"><link rel="prefetch" href="/blog/assets/js/24.8fcb4240.js"><link rel="prefetch" href="/blog/assets/js/25.87fb2a64.js"><link rel="prefetch" href="/blog/assets/js/26.2b5af622.js"><link rel="prefetch" href="/blog/assets/js/27.9dd2f635.js"><link rel="prefetch" href="/blog/assets/js/28.620223b0.js"><link rel="prefetch" href="/blog/assets/js/29.b5132cc0.js"><link rel="prefetch" href="/blog/assets/js/30.e5fc9660.js"><link rel="prefetch" href="/blog/assets/js/31.cc3636e0.js"><link rel="prefetch" href="/blog/assets/js/32.07f2368f.js"><link rel="prefetch" href="/blog/assets/js/33.f322c3b4.js"><link rel="prefetch" href="/blog/assets/js/34.9dd28441.js"><link rel="prefetch" href="/blog/assets/js/35.26f89bd6.js"><link rel="prefetch" href="/blog/assets/js/36.0ad3ed5b.js"><link rel="prefetch" href="/blog/assets/js/37.a5beb387.js"><link rel="prefetch" href="/blog/assets/js/38.52cf41ae.js"><link rel="prefetch" href="/blog/assets/js/39.01010e58.js"><link rel="prefetch" href="/blog/assets/js/40.f8c98cc3.js"><link rel="prefetch" href="/blog/assets/js/41.8971de6f.js"><link rel="prefetch" href="/blog/assets/js/42.bcb81ef0.js"><link rel="prefetch" href="/blog/assets/js/43.4ad814a8.js"><link rel="prefetch" href="/blog/assets/js/44.c867afa4.js"><link rel="prefetch" href="/blog/assets/js/45.8c3374a3.js"><link rel="prefetch" href="/blog/assets/js/46.1db62c8f.js"><link rel="prefetch" href="/blog/assets/js/47.ac761158.js"><link rel="prefetch" href="/blog/assets/js/48.65ed8359.js"><link rel="prefetch" href="/blog/assets/js/49.eea27004.js"><link rel="prefetch" href="/blog/assets/js/5.36260e9d.js"><link rel="prefetch" href="/blog/assets/js/50.8eafa05e.js"><link rel="prefetch" href="/blog/assets/js/52.c5c26bef.js"><link rel="prefetch" href="/blog/assets/js/53.3fb73f30.js"><link rel="prefetch" href="/blog/assets/js/54.52ecb194.js"><link rel="prefetch" href="/blog/assets/js/55.1fb9effa.js"><link rel="prefetch" href="/blog/assets/js/56.7e8e15e9.js"><link rel="prefetch" href="/blog/assets/js/57.c2c0eafb.js"><link rel="prefetch" href="/blog/assets/js/58.6fca8eea.js"><link rel="prefetch" href="/blog/assets/js/59.9ac5ca25.js"><link rel="prefetch" href="/blog/assets/js/6.3cb3a407.js"><link rel="prefetch" href="/blog/assets/js/60.44e53681.js"><link rel="prefetch" href="/blog/assets/js/61.10b13fbe.js"><link rel="prefetch" href="/blog/assets/js/62.915f77c6.js"><link rel="prefetch" href="/blog/assets/js/63.4d3cf238.js"><link rel="prefetch" href="/blog/assets/js/64.4cc47eb1.js"><link rel="prefetch" href="/blog/assets/js/65.1b03cbab.js"><link rel="prefetch" href="/blog/assets/js/66.3de2e01a.js"><link rel="prefetch" href="/blog/assets/js/67.027b34df.js"><link rel="prefetch" href="/blog/assets/js/68.a386474a.js"><link rel="prefetch" href="/blog/assets/js/69.aa4fa7ef.js"><link rel="prefetch" href="/blog/assets/js/7.6af1cf93.js"><link rel="prefetch" href="/blog/assets/js/70.9ec8a88a.js"><link rel="prefetch" href="/blog/assets/js/71.f609366f.js"><link rel="prefetch" href="/blog/assets/js/72.25b2daac.js"><link rel="prefetch" href="/blog/assets/js/73.48f3a309.js"><link rel="prefetch" href="/blog/assets/js/74.3f82cd07.js"><link rel="prefetch" href="/blog/assets/js/75.2f2bc274.js"><link rel="prefetch" href="/blog/assets/js/76.abc1534b.js"><link rel="prefetch" href="/blog/assets/js/77.49c8b0c5.js"><link rel="prefetch" href="/blog/assets/js/78.97ad82e2.js"><link rel="prefetch" href="/blog/assets/js/79.c64487b4.js"><link rel="prefetch" href="/blog/assets/js/8.259b9f4b.js"><link rel="prefetch" href="/blog/assets/js/80.556858e5.js"><link rel="prefetch" href="/blog/assets/js/81.0c11d233.js"><link rel="prefetch" href="/blog/assets/js/82.ac516c8e.js"><link rel="prefetch" href="/blog/assets/js/83.b1f34125.js"><link rel="prefetch" href="/blog/assets/js/84.0cef5ae7.js"><link rel="prefetch" href="/blog/assets/js/85.3efe19f7.js"><link rel="prefetch" href="/blog/assets/js/86.d258c1ee.js"><link rel="prefetch" href="/blog/assets/js/87.e3c49335.js"><link rel="prefetch" href="/blog/assets/js/88.d2bd0456.js"><link rel="prefetch" href="/blog/assets/js/89.35168226.js"><link rel="prefetch" href="/blog/assets/js/9.b95a6eec.js"><link rel="prefetch" href="/blog/assets/js/90.1f6c75a1.js"><link rel="prefetch" href="/blog/assets/js/91.6d7ddc82.js"><link rel="prefetch" href="/blog/assets/js/92.460ea3dc.js"><link rel="prefetch" href="/blog/assets/js/93.3068fe94.js"><link rel="prefetch" href="/blog/assets/js/94.e0b7832a.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.9459b9ea.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.bb8e4b6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>小丑不哭</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Jooker</span>
            
          <span data-v-64685f0e>2020 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="小丑不哭" class="logo"> <span class="site-name">小丑不哭</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/前端知识/" class="nav-link"><i class="iconfont undefined"></i>
  前端知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/原创文章/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/computer/" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/browser/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/js/" class="nav-link"><i class="iconfont undefined"></i>
  JS语法基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/native/" class="nav-link"><i class="iconfont undefined"></i>
  客户端基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/general/" class="nav-link"><i class="iconfont undefined"></i>
  通用编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  后端基础
</a></li><li class="dropdown-item"><h4>框架原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/docs/framework/react/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/react16/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  React16
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/docs/libs/" class="nav-link"><i class="iconfont undefined"></i>
  类库基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/engineer/" class="nav-link"><i class="iconfont undefined"></i>
  工程化体系
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/softSkill/" class="nav-link"><i class="iconfont undefined"></i>
  软技能
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/future/" class="nav-link"><i class="iconfont undefined"></i>
  前沿技术
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/math/" class="nav-link"><i class="iconfont undefined"></i>
  数学基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/article/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jo-ko" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://twitter.com/Jooker18506261" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-twitter"></i>
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="/blog/avatar.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    Jooker
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>58</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>10</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/前端知识/" class="nav-link"><i class="iconfont undefined"></i>
  前端知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/原创文章/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/computer/" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/browser/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/js/" class="nav-link"><i class="iconfont undefined"></i>
  JS语法基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/native/" class="nav-link"><i class="iconfont undefined"></i>
  客户端基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/general/" class="nav-link"><i class="iconfont undefined"></i>
  通用编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  后端基础
</a></li><li class="dropdown-item"><h4>框架原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/docs/framework/react/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/react16/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  React16
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/docs/libs/" class="nav-link"><i class="iconfont undefined"></i>
  类库基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/engineer/" class="nav-link"><i class="iconfont undefined"></i>
  工程化体系
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/softSkill/" class="nav-link"><i class="iconfont undefined"></i>
  软技能
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/future/" class="nav-link"><i class="iconfont undefined"></i>
  前沿技术
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/math/" class="nav-link"><i class="iconfont undefined"></i>
  数学基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/article/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jo-ko" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://twitter.com/Jooker18506261" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-twitter"></i>
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/blog/docs/framework/react16/" aria-current="page" class="sidebar-link">简述</a></li><li><a href="/blog/docs/framework/react16/react_origin_renderAndUpdate.html" class="sidebar-link">React16源码-render&amp;更新</a></li><li><a href="/blog/docs/framework/react16/react_origin_schedule.html" aria-current="page" class="active sidebar-link">React源码-schedule</a></li><li><a href="/blog/docs/framework/react16/react_origin_renderRoot.html" class="sidebar-link">React源码-renderRoot</a></li><li><a href="/blog/docs/framework/react16/react_origin_diff.html" class="sidebar-link">React源码-Diff</a></li><li><a href="/blog/docs/framework/react16/react_origin_completeWork.html" class="sidebar-link">React源码-completeWork</a></li><li><a href="/blog/docs/framework/react16/react_origin_completeRoot.html" class="sidebar-link">React源码-completeRoot</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>React源码-schedule</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Jooker</span>
            
          <span data-v-64685f0e>2020 - </span>
          2022
        </a></span></div></div> <div data-v-2d5f533b><main class="page"><div class="page-title" style="display:none;"><h1 class="title">React源码-schedule</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Jooker</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2020-02-01</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>框架基础</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>在调用render, setState, forceUpdate的最后,最终都会调用scheduleWork进入Schedule调度中心</p></blockquote> <h2 id="schedulework"><a href="#schedulework" class="header-anchor">#</a> scheduleWork</h2> <ol><li>找到FiberRoot,比较新任务的过期时间和Fiber节点上的过期时间大小,将过期时间设置为优先级高的</li> <li>判断新任务优先级,执行旧任务打断,<strong>这里的任务是指renderRoot阶段开始的任务</strong></li> <li>调用requestWork推入新任务</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">scheduleWork</span><span class="token punctuation">(</span>
    fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// render调用传入的是RootFiber,setState和foceUpdate传入的是调用实例的Fiber </span>
    expirationTime<span class="token operator">:</span> ExpirationTime <span class="token comment">// 新任务的优先级</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从该Fiber节点向上找到FiberRoot,同时更新当点Fiber节点的expirationTime属性和所有祖宗节点的childExpirationTime</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token comment">// isWorking这个全局参数会在commitRoot和renderRoot阶段开始时会设置为true,结束为false,这两个阶段后面会讲到</span>
  <span class="token comment">// 这个分支表示当前有一个优先级较低的异步任务没有执行完,但此时权限已经交给了宿主环境,但是新的任务的优先级要更高一点</span>
  <span class="token comment">// 这样之前优先级低的任务就被打断了  </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>isWorking <span class="token operator">&amp;&amp;</span>
    nextRenderExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
    expirationTime <span class="token operator">&gt;</span> nextRenderExpirationTime
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interruptedBy <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token comment">// 重置stack,会从nextUnitOfWork开始一步一步往上恢复,之前的任务会被重置</span>
    <span class="token comment">// 重置所有的公共变量  </span>
    <span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 重新设置FiberRoot中的earliestPendingTime和latestPendingTime</span>
  <span class="token comment">// 重新设置FiberRoot中的nextExpirationTimeToWorkOn和exprationTime</span>
  <span class="token comment">// 目的是找出下个需要执行的最高优先级  </span>
  <span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// isCommitting会在commitRoot阶段开始设置为true, 结束设置为false</span>
  <span class="token comment">// 所以只要不是render阶段就调用requestork推入任务</span>
  <span class="token comment">// 注意这里传入的优先级(过期时间)并一定是新任务的优先级,而是Fiber子节点中的最高优先级</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>isWorking <span class="token operator">||</span>
    isCommitting <span class="token operator">||</span>
    nextRoot <span class="token operator">!==</span> root
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token function">requestWork</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rootExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 这块是对调度的合理性检查</span>
  <span class="token comment">// 当我们在render方法中调用setState,会造成死循环</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedUpdateCount <span class="token operator">&gt;</span> <span class="token constant">NESTED_UPDATE_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// ...报错 </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span>fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发模式下记录性能信息</span>
    <span class="token function">recordScheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前Fiber节点的优先级小于新任务的优先级, 重新设置该节点的优先级 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取workInProgress, 同步优先级</span>
    <span class="token keyword">let</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从当前的Fiber节点向上遍历祖宗节点直到RootFiber节点</span>
    <span class="token comment">// 遍历到的节点和对应的workInProgress节点都更新childExpirationTime</span>
    <span class="token comment">// 遍历到Rootiber节点时,返回对应的FiberRoot</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这块就是向上遍历Fibr链表</span>
        <span class="token comment">// 关于workInProgress这段设置优先级的代码写的有点冗余,可以合并一下</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alternate <span class="token operator">=</span> node<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                    alternate <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
                    alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
                alternate <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
                alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// ... </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span>
    root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
    expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// 防止FiberRoot由于之前的错误导致尝试新的更新 </span>
    root<span class="token punctuation">.</span>didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> earliestPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>earliestPendingTime<span class="token punctuation">;</span>
    <span class="token comment">// 设置FiberRoot中所标识的子节点中最高优先级和最低优先级</span>
    <span class="token comment">// 如果之前没有设置过最高优先级和最低优先级,就赋值为新任务的优先级</span>
    <span class="token comment">// 否则更新这两个属性,使得新任务的优先级在两个属性之间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earliestPendingTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span>earliestPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>latestPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earliestPendingTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root<span class="token punctuation">.</span>earliestPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> latestPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>latestPendingTime<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>latestPendingTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                root<span class="token punctuation">.</span>latestPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置nextExpirationTimeToWorkOn和exprationTime</span>
    <span class="token comment">// nextExpirationTimeToWorkOn = earliestPendingTime ? earliestPendingTime : latestPingedTime || latestSuspendedTime</span>
    <span class="token comment">// expirationTime = nextExpirationTimeToWorkOn &gt; earliestSuspendedTime ? nextExpirationTimeToWorkOn : earliestSuspendedTime </span>
    <span class="token function">findNextExpirationTimeToWorkOn</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><h2 id="requestwork"><a href="#requestwork" class="header-anchor">#</a> requestWork</h2> <ol><li>将新任务的FiberRoot添加到Root调度单向循环链表中, 同时更新FiberRoot的expirationTime</li> <li>根据优先级和初始化状态来执行performWorkOnRoot &amp; performSyncWork &amp; performAsyncWork,这几个方法后面会讲到</li></ol> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">requestWork</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将FiberRoot加入到Root调度队列中</span>
    <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// isRendering会在performWorkOnRoot开始时设置为true</span>
    <span class="token comment">// performWorkOnRoot会遍历Root调度链表,不用重新更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下面的分支是判断是否需要批量更新</span>
    <span class="token comment">// 当我们在合成事件调用更新的时候isBatchingUpdates会设置为true,isUnbatchingUpdates会设置为false</span>
    <span class="token comment">// 合成事件需要批量更新,因此不会马上执行调度更新</span>
    <span class="token comment">// 对于首次挂载的会直接走这个分支,直接执行performWorkOnRoot</span>
    <span class="token comment">// performWorkOnRoot &amp; performSyncWork &amp; performAsyncWork &amp; performWork 是整个调度环节最后真正去执行的reconciler部分</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnbatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextFlushedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
            nextFlushedExpirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
            <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里判断优先级是同步还是异步</span>
    <span class="token comment">// 同步直接调用performSyncWork, 异步进入调度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 检查当前FiberRoot是否在调度队列中,没有就将其推入链表</span>
    <span class="token comment">// 更新expirationTime(render和普通更新的前后过期时间是一致的)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同时设置firstScheduledRoot和lastScheduledRoot </span>
        root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastScheduledRoot <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstScheduledRoot <span class="token operator">=</span> lastScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
            root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 一般情况我们只有一个root, 多个root的情况会走这个分支</span>
            lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
            lastScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
            lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明该FiberRoot已经在调度队列中,直接更新expirationTime</span>
        <span class="token keyword">const</span> remainingExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">&gt;</span> remainingExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 优先级更高时更新</span>
            root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="schedulecallbackwithexpirationtime"><a href="#schedulecallbackwithexpirationtime" class="header-anchor">#</a> scheduleCallbackWithExpirationTime</h2> <ol><li>异步进行root任务调度</li> <li>取消低优先级的Root调度任务, <strong>这里的任务指的是还未进入performWork中任务</strong></li> <li>调用unstable_scheduleCallback将performAsyncWork <strong>按照优先级</strong> 加入callbackNode <strong>双向循环链表</strong>,以便在空闲时候调用</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>
    root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
    expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否已经存在调度任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackExpirationTime <span class="token operator">!==</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果已经存在调度任务,需要比对新旧任务的优先级</span>
        <span class="token comment">// 如果传入的任务比已经在调度的任务优先级低就直接退出</span>
        <span class="token comment">// 如果传入的任务比已经在调度的任务优先级高就取消之前的任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">&lt;</span> callbackExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackID <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cancelDeferredCallback</span><span class="token punctuation">(</span>callbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// The request callback timer is already running. Don't start a new one.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">startRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 标识调度开始</span>
    callbackExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token comment">// 计算出任务超时时间</span>
    <span class="token comment">// timeout = 过期时间 - 当前任务创建时间, 即为距离现在还有多久过期</span>
    <span class="token keyword">const</span> currentMs <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> originalStartTimeMs<span class="token punctuation">;</span>
    <span class="token keyword">const</span> expirationTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timeout <span class="token operator">=</span> expirationTimeMs <span class="token operator">-</span> currentMs<span class="token punctuation">;</span>
    callbackID <span class="token operator">=</span> <span class="token function">scheduleDeferredCallback</span><span class="token punctuation">(</span>performAsyncWork<span class="token punctuation">,</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// scheduleDeferredCallback, 在独立包Schedule.js中</span>
<span class="token comment">// 创建新的callbaclNode,按照优先级插入到队列中</span>
<span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span>
    callback<span class="token punctuation">,</span> <span class="token comment">// 就是performWork,可以简单理解为是带有暂定跳出功能的V15版本的Reconciler</span>
    deprecated_options <span class="token comment">// {timeout}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 计算出该函数开始的时间</span>
    <span class="token keyword">var</span> startTime <span class="token operator">=</span>
        currentEventStartTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> currentEventStartTime <span class="token operator">:</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> deprecated_options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
        deprecated_options <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> deprecated_options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 目前16版本的只会走这个分支</span>
        <span class="token comment">// 传入的deprecated_options都是{timeout}</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> deprecated_options<span class="token punctuation">.</span>timeout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建新的callbackNode</span>
    <span class="token keyword">var</span> newNode <span class="token operator">=</span> <span class="token punctuation">{</span>
        callback<span class="token punctuation">,</span>
        priorityLevel<span class="token operator">:</span> currentPriorityLevel<span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
        next<span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
        previous<span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Insert the new callback into the list, ordered first by expiration, then</span>
    <span class="token comment">// by insertion. So the new callback is inserted any other callback with</span>
    <span class="token comment">// equal expiration.</span>
    <span class="token comment">// 下面阶段是按照优先级高低将新callback加入链表</span>
    <span class="token comment">// firstCallbackNode的优先级最高,lastCallbackNode优先级最低 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果链表不存在, 直接将newNode作为firstCallbackNode</span>
        firstCallbackNode <span class="token operator">=</span> newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
        <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> next <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> node <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个循环是找到当前链表中优先级比新callbackNode低的任务,赋值给next</span>
            <span class="token comment">// 这里会比较奇怪,之前的是expirationTime越大,优先级越高,但是到这越大反而优先级越低</span>
            <span class="token comment">// 因为当前的expirationTime不是之前的expirationTime</span>
            <span class="token comment">// 当前expirationTime = startTime + deprecated_options.timeout(优先级越高,timeout就越小,因此expirationTime也就越小);</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            node <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> firstCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明新节点的优先级最低</span>
            <span class="token comment">// 设置next为当前的firstCallbackNode是为了后面的链表操作</span>
            next <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> firstCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明新节点的优先级最高</span>
            <span class="token comment">// 将其作为第一个待执行的callback任务, 调用ensureHostCallbackIsScheduled</span>
            firstCallbackNode <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
            <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这里涉及循环链表的操作, 无论新callbackNode优先级,它都插入到了next节点的前面</span>
        <span class="token comment">// 新callbackNode优先级最低, 插入原firstCallbackNode的前面, 成为最后一个节点</span>
        <span class="token comment">// 新callbackNode优先级最低, 插入原firstCallbackNode的前面, 修改firstCallbackNode指针指向新callbackNode, 成为第一个节点 </span>
        <span class="token keyword">var</span> previous <span class="token operator">=</span> next<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
        previous<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
        newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> newNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主要目的是在执行requestHostCallback调度时候确认是否有callback任务在执行</span>
<span class="token comment">// isHostCallbackScheduled标识 表示是否已经进入requestAnimationFrameWithTimeout调度</span>
<span class="token comment">// isExecutingCallback标识 表示已经进入requestAnimationFrameWithTimeout调度,是否开始执行flushWork</span>
<span class="token comment">// 对已经在执行flushWork的callback,我们无法取消</span>
<span class="token comment">// 对已经执行requestAnimationFrameWithTimeout但未执行flushWork的callback,我们可以取消</span>
<span class="token keyword">function</span> <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isExecutingCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">cancelHostCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 传入的flushWork就是用来遍历callback链表的</span>
    <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><h2 id="requesthostcallback"><a href="#requesthostcallback" class="header-anchor">#</a> requestHostCallback</h2> <ol><li>用来模拟requestIdlCallback</li> <li>通过window.postMessage让任务在下一个事件轮询时候第一个执行</li> <li>通过requestAnimationFrame和setTimeout来调度任务到下一个事件轮询检查执行</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code>  <span class="token keyword">const</span> <span class="token function-variable function">requestHostCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    callback<span class="token punctuation">,</span> <span class="token comment">// flushWork</span>
    absoluteTimeout <span class="token comment">// expirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span> <span class="token comment">// 需要在调度执行的任务flushWork</span>
    timeoutTime <span class="token operator">=</span> absoluteTimeout<span class="token punctuation">;</span> <span class="token comment">// 任务过期时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlushingHostCallback <span class="token operator">||</span> absoluteTimeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// isFlushingHostCallback表示需要立即执行</span>
        <span class="token comment">// 超时了也需要立即执行</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAnimationFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 由于requestAnimationFrame在tab切换或者浏览器在后台运行会导致终止运行</span>
<span class="token comment">// 因此通过setTimeout来作为临时补偿</span>
<span class="token comment">// 这里需要了解一帧的生命周期,requestAnimationFrame会在当前帧渲染执行, setTimeout在下一帧执行</span>
<span class="token comment">// 因此requestAnimationFrame执行会取消setTimeout, setTimeout执行会取消requestAnimationFrame</span>
<span class="token keyword">var</span> <span class="token function-variable function">requestAnimationFrameWithTimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    callback <span class="token comment">// animationTick,用于有任务的时候递归调用requestAnimationFrameWithTimeout去执行</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// timestamp是DOMHighResTimeStamp参数，该参数与performance.now()的返回值相同</span>
    <span class="token comment">// 表示requestAnimationFrame执行的时间</span>
    rAFID <span class="token operator">=</span> <span class="token function">localRequestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">localClearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rAFTimeoutID <span class="token operator">=</span> <span class="token function">localSetTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">localCancelAnimationFrame</span><span class="token punctuation">(</span>rAFID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">ANIMATION_FRAME_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ANIMATION_FRAME_TIMEOUT = 100</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="animationtick"><a href="#animationtick" class="header-anchor">#</a> animationTick</h2> <p>animationTick是模拟requestIdlCallback的核心,主要有三个功能</p> <ol><li>获取下一帧的结束时间frameDeadline</li> <li>通过MessageChannel触发当前任务在下一帧执行</li> <li>递归触发下一个任务</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token comment">// 首先我们要知道animationTick这个函数是在下一帧的requestAnimationFrame的回调阶段执行</span>
<span class="token comment">// postMessage触发的回调会在下一帧最早执行</span>
<span class="token keyword">var</span> <span class="token function-variable function">animationTick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    rafTime <span class="token comment">// 当前帧开始的时间</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果还有callback任务,则递归继续在下一帧调用 </span>
        <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有任务就退出 </span>
        isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// activeFrameTime初始值为 33</span>
    <span class="token comment">// frameDeadline所表示的有点绕,在这里表示的上一帧的截止时间, 初始值为 0</span>
    <span class="token comment">// nextFrameTime = 当前调用时间 - 上一帧帧截止时间 + 一帧的时间, </span>
    <span class="token comment">// 用数学表示 nextFrameTime = new_rafTime - （old_rafTime + old_activeFrameTime） + new_activeFrameTime</span>
    <span class="token comment">//                        = new_rafTime - old_rafTime - (old_activeFrameTime - new_activeFrameTime)</span>
    <span class="token comment">//                        = new_rafTime - old_rafTime </span>
    <span class="token comment">// 也就是nextFrameTime表示实际上一帧经历的时间, 通过前后差值来调整activeFrameTime</span>
    <span class="token keyword">var</span> nextFrameTime <span class="token operator">=</span> rafTime <span class="token operator">-</span> frameDeadline <span class="token operator">+</span> activeFrameTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        nextFrameTime <span class="token operator">&lt;</span> activeFrameTime <span class="token operator">&amp;&amp;</span>
        previousFrameTime <span class="token operator">&lt;</span> activeFrameTime
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 下面的操作是为了动态修改activeFrameTime</span>
        <span class="token comment">// 当2次两个任务之间的执行时间小于activeFrameTime,说明平台的帧率较高, 就设定activeFrameTime其为其中较大的一个</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFrameTime <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里不支持高帧率的刷新(120HZ) </span>
            nextFrameTime <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        activeFrameTime <span class="token operator">=</span>
            nextFrameTime <span class="token operator">&lt;</span> previousFrameTime <span class="token operator">?</span> previousFrameTime <span class="token operator">:</span> nextFrameTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保存上次的间隔时间用于对比</span>
        previousFrameTime <span class="token operator">=</span> nextFrameTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// frameDeadline在这里被赋值成下一帧的截止时间</span>
    <span class="token comment">// 按照EventLoop的规则,在requestAnimationFrame之后还有浏览器的layout和paint阶段才是这一帧的结束,但是一般此时并无样式布局的变化,因此会跳过这个阶段</span>
    <span class="token comment">// 即使发生的样式布局变化进入了layout和paint阶段,由于一帧的时间(activeFrameTime)是动态调节的,可以修正这个误差</span>
    <span class="token comment">// 所以frameDeadline = 当前时间 + layoutPaintingTime + 一帧的时间 = 当前时间 + 一帧的时间 </span>
    frameDeadline <span class="token operator">=</span> rafTime <span class="token operator">+</span> activeFrameTime<span class="token punctuation">;</span>
   
    <span class="token comment">// isMessageEventScheduled表示每一帧的animationTick是否已经被执行完</span>
    <span class="token comment">// 至此触发port1的监听回调,进入到下一帧执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageEventScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isMessageEventScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// port.postMessage(undefined) 触发onmessage回调</span>
<span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isMessageEventScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// react有很多这种开始将全局变量重新赋值给局部临时变量的,先保留之前的值,在执行完某个操作之后,再还原某个值</span>
    <span class="token comment">// 1. 是为了避免在后面调用的时候由于作用域链的问题向上查找引起的时间浪费</span>
    <span class="token comment">// 2. 是告知执行和回滚状态</span>
    <span class="token keyword">var</span> prevScheduledCallback <span class="token operator">=</span> scheduledHostCallback<span class="token punctuation">;</span> <span class="token comment">// fleshWork</span>
    <span class="token keyword">var</span> prevTimeoutTime <span class="token operator">=</span> timeoutTime<span class="token punctuation">;</span> <span class="token comment">// expirationTime</span>
    scheduledHostCallback <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    timeoutTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> didTimeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 这块frameDeadline的值就是animationTick计算出当前帧的一个过期时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frameDeadline <span class="token operator">-</span> currentTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevTimeoutTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prevTimeoutTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明任务已经过期了, prevTimeoutTime是任务的过期时间</span>
            didTimeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// isAnimationFrameScheduled是判断是否在逐帧执行animationTick遍历scheduleCallback任务的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAnimationFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 重启遍历scheduleCallback任务</span>
                isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 因为上一个任务没有执行完,回滚原来的值,以便在requestAnimationFrameWithTimeout执行</span>
            scheduledHostCallback <span class="token operator">=</span> prevScheduledCallback<span class="token punctuation">;</span>
            timeoutTime <span class="token operator">=</span> prevTimeoutTime<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 说明当前帧没超时</span>
    <span class="token comment">// 执行scheduleCallback, 进入flushWork</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevScheduledCallback <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isFlushingHostCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">prevScheduledCallback</span><span class="token punctuation">(</span>didTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            isFlushingHostCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><h2 id="flushwork"><a href="#flushwork" class="header-anchor">#</a> flushWork</h2> <blockquote><p>flushWork就是一个时间分片要执行的内容</p></blockquote> <ol><li>超时情况执行过期的callback任务</li> <li>非超时情况在一帧内最大化的执行callback任务</li> <li>最后执行其余任务</li></ol> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span>
    didTimeout <span class="token comment">// 是否超时</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在调试或者显示暂停调度的时候返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 标识是否已经开始flushWork</span>
    isExecutingCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousDidTimeout <span class="token operator">=</span> currentDidTimeout<span class="token punctuation">;</span>
    currentDidTimeout <span class="token operator">=</span> didTimeout<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 已经超时,就执行所有已经过期的callback任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 通过比较当前时间和任务的过期时间</span>
                <span class="token comment">// 在unstable_scheduleCallback中我们会把任务按照优先级最高(最早过期)到最低的排序</span>
                <span class="token comment">// 如果第一个任务已经过期了,后面的任务也可能过期了</span>
                <span class="token comment">// 如果第一个任务没过期,后面的任务也不会过期</span>
                <span class="token comment">// 通过调用flushFirstCallback来推进任务</span>
                <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>
                        firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                        firstCallbackNode<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 表示没有超时</span>
            <span class="token comment">// 同样调用flushFirstCallback推进任务</span>
            <span class="token comment">// 在每次调用flushFirstCallback后检查是否超时</span>
            <span class="token comment">// shouldYieldToHost = () =&gt; frameDeadline &lt;= getCurrentTime();</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        isExecutingCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        currentDidTimeout <span class="token operator">=</span> previousDidTimeout<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 还有一些低优先级的任务未执行, 继续调度</span>
            <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 最后在结束的时候,将所有优先级为ImmediatePriority的任务处理 </span>
        <span class="token function">flushImmediateWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用callbackNode的执行函数performWork</span>
<span class="token keyword">function</span> <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> flushedNode <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>

    <span class="token comment">// 从队列中获取并移除 firstCallbackNode, 这样即时出错了也能保持一致, 否则等到结束再移除会导致不一致问题</span>
    <span class="token keyword">var</span> next <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前节点是最后一个节点</span>
        firstCallbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除callback链表中的第一个callbackNode</span>
        <span class="token keyword">var</span> lastCallbackNode <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
        firstCallbackNode <span class="token operator">=</span> lastCallbackNode<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        next<span class="token punctuation">.</span>previous <span class="token operator">=</span> lastCallbackNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 移除callbackNode上的链接属性信息</span>
    flushedNode<span class="token punctuation">.</span>next <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 安全的获取callbackNode上的执行属性</span>
    <span class="token comment">// 这里执行了performWork</span>
    <span class="token comment">// flushedNode.callback是在unstable_scheduleCallback创建node是赋予的,其实就是performWork这个方法</span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">var</span> priorityLevel <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>priorityLevel<span class="token punctuation">;</span>
    <span class="token keyword">var</span> previousPriorityLevel <span class="token operator">=</span> currentPriorityLevel<span class="token punctuation">;</span>
    <span class="token keyword">var</span> previousExpirationTime <span class="token operator">=</span> currentExpirationTime<span class="token punctuation">;</span>
    currentPriorityLevel <span class="token operator">=</span> priorityLevel<span class="token punctuation">;</span>
    currentExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token keyword">var</span> continuationCallback<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        currentPriorityLevel <span class="token operator">=</span> previousPriorityLevel<span class="token punctuation">;</span>
        currentExpirationTime <span class="token operator">=</span> previousExpirationTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// 如果performWork返回的是函数, 就把它加入callback链表中</span>
    <span class="token comment">// 整个插入过程类似scheduleCallback中创建node根据优先级插入,不同的是遇到优先级相同的情况,会将其插到前面,而不是后面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> continuationNode<span class="token operator">:</span> CallbackNode <span class="token operator">=</span> <span class="token punctuation">{</span>
            callback<span class="token operator">:</span> continuationCallback<span class="token punctuation">,</span>
            priorityLevel<span class="token punctuation">,</span>
            expirationTime<span class="token punctuation">,</span>
            next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            previous<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// callback链表已经空的情况,直接赋值给firstCallbackNode</span>
            firstCallbackNode <span class="token operator">=</span> continuationNode<span class="token punctuation">.</span>next <span class="token operator">=</span> continuationNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> nextAfterContinuation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> node <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextAfterContinuation <span class="token operator">=</span> node<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                node <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> firstCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAfterContinuation <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextAfterContinuation <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAfterContinuation <span class="token operator">===</span> firstCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                firstCallbackNode <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
                <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">var</span> previous <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
            previous<span class="token punctuation">.</span>next <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">.</span>previous <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
            continuationNode<span class="token punctuation">.</span>next <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">;</span>
            continuationNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br></div></div><h2 id="performasyncwork-performsyncwork-performwork-performworkonroot"><a href="#performasyncwork-performsyncwork-performwork-performworkonroot" class="header-anchor">#</a> performAsyncWork &amp; performSyncWork &amp; performWork &amp; performWorkOnRoot</h2> <ol><li>performAsyncWork, performSyncWork最终都会调用performWork,只是传入的参数不一样</li> <li>performWork 最终调用performWorkOnRoot</li></ol> <h3 id="performasyncwork-performsyncwork-performwork"><a href="#performasyncwork-performsyncwork-performwork" class="header-anchor">#</a> performAsyncWork &amp; performSyncWork &amp; performWork</h3> <blockquote><p>performAsyncWork &amp; performSyncWork算是一个调度周期</p></blockquote> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">performAsyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldYieldToRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 进入这个分支说明一帧的时间已经超时,并且已经有任务过期了</span>
            <span class="token comment">// 重新计算当前时间currentRendererTime, 并将该事件设置为FiberRoot的nextExpirationTimeToWorkOn</span>
            <span class="token comment">// 该时间决定哪些节点的更新要在当前周期中被执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstScheduledRoot <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> root<span class="token operator">:</span> FiberRoot <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token function">didExpireAtExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> currentRendererTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// scheduleRoot链表是循环链表</span>
                    root <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>nextScheduledRoot<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> firstScheduledRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">performWork</span><span class="token punctuation">(</span>NoWork<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        didYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performWork</span><span class="token punctuation">(</span>Sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shouldYieldToRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>didYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didYield <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// shouldYield schedule.js</span>
<span class="token comment">// 判断一帧超时并且有任务过期</span>
<span class="token keyword">function</span> <span class="token function">unstable_shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token comment">// currentDidTimeout首次渲染时为false</span>
        <span class="token comment">// 当前的callbackNode任务过期 &amp;&amp; 一帧的时间已经超时 就返回true,否则返回false</span>
        <span class="token operator">!</span>currentDidTimeout <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
            firstCallbackNode<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> currentExpirationTime<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performWork</span><span class="token punctuation">(</span>
    minExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span> <span class="token comment">// NoWork或者Sync，表示最小的到期时间</span>
    isYieldy<span class="token operator">:</span> <span class="token type tag">boolean</span> <span class="token comment">// true表示异步的需要调度，false表示是同步的不需要调度</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取root调度链表中最高优先级的root节点</span>
    <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异步任务</span>
        <span class="token comment">// 重新计算当前渲染时间</span>
        <span class="token comment">// 同步currentSchedulerTime和currentRendererTime</span>
        <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableUserTimingAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// debugger时候时候调用</span>
           <span class="token comment">// .... </span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 循环执行rootSchedule中优先级最高的root更新任务</span>
        <span class="token comment">// 循环停止的条件: 所有root更新任务完成或者一帧超时并且有任务过期</span>
        <span class="token comment">// 同步currentSchedulerTime和currentRendererTime</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>
            nextFlushedRoot <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
            nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
            minExpirationTime <span class="token operator">&lt;=</span> nextFlushedExpirationTime <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>didYield <span class="token operator">&amp;&amp;</span> currentRendererTime <span class="token operator">&gt;</span> nextFlushedExpirationTime<span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>
                nextFlushedRoot<span class="token punctuation">,</span>
                nextFlushedExpirationTime<span class="token punctuation">,</span>
                currentRendererTime <span class="token operator">&gt;</span> nextFlushedExpirationTime<span class="token punctuation">,</span> <span class="token comment">// true表示没过期, false表示过期 </span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 由于通过调用performWorkOnRoot会执行一些生命周期函数，导致每个root上的更新任务会变化，即最高的优先级会变化</span>
            <span class="token comment">// 因此需要调用findHighestPriorityRoot来更新nextFlushedExpirationTime</span>
            <span class="token comment">// 同时需要更新当前渲染时间, 判断任务是否过期</span>
            <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同步任务</span>
        <span class="token comment">// 不断找到优先级最高的scheduleRoot执行更新</span>
        <span class="token comment">// 和异步任务一样,performWorkOnRoot可能会产生新的更新任务,根据任务的类型进入同步或者异步的调度队列</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>
            nextFlushedRoot <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
            nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
            <span class="token comment">// 这个情况下minExpirationTime = nextFlushedExpirationTime = Sync </span>
            minExpirationTime <span class="token operator">&lt;=</span> nextFlushedExpirationTime
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>nextFlushedRoot<span class="token punctuation">,</span> nextFlushedExpirationTime<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行完当前任务后,重置 callbackID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
        callbackID <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果还有一些未过期的scheduleRoot异步任务,继续走新一轮调度流程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFlushedExpirationTime <span class="token operator">!==</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>nextFlushedRoot<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nextFlushedExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 结束渲染</span>
    <span class="token function">finishRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在多个root更新任务链表中找到优先级最高的</span>
<span class="token comment">// 大部分情况下我们只有一个root</span>
<span class="token comment">// 不过因为react支持多个实例,即支持调用多次ReactDOM.render</span>
<span class="token keyword">function</span> <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> highestPriorityWork <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
    <span class="token keyword">let</span> highestPriorityRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastScheduledRoot <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> previousScheduledRoot <span class="token operator">=</span> lastScheduledRoot<span class="token punctuation">;</span>
        <span class="token keyword">let</span> root <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
        <span class="token comment">// 下面循环查询最大优先级的任务</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> remainingExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingExpirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// NoWork说明该root已经没有需要更新的任务了</span>
                <span class="token comment">// 下面的操作将其从链表中删除的逻辑</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
                    firstScheduledRoot <span class="token operator">=</span> lastScheduledRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> firstScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> next <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
                    firstScheduledRoot <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> lastScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastScheduledRoot <span class="token operator">=</span> previousScheduledRoot<span class="token punctuation">;</span>
                    lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
                    root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    previousScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
                    root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                root <span class="token operator">=</span> previousScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这块的逻辑是找到优先级最高的root节点</span>
                <span class="token comment">// 注意这里过期时间越大优先级越大</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingExpirationTime <span class="token operator">&gt;</span> highestPriorityWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    highestPriorityWork <span class="token operator">=</span> remainingExpirationTime<span class="token punctuation">;</span>
                    highestPriorityRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> lastScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>highestPriorityWork <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 遇到同步任务直接跳出查询</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                previousScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
                root <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将查询到最高优先级任务和优先级赋值于全局对象</span>
    <span class="token comment">// nextFlushedRoot&amp;nextFlushedExpirationTime会在performWorkOnRoot被用到 </span>
    nextFlushedRoot <span class="token operator">=</span> highestPriorityRoot<span class="token punctuation">;</span>
    nextFlushedExpirationTime <span class="token operator">=</span> highestPriorityWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br></div></div><h3 id="performworkonroot"><a href="#performworkonroot" class="header-anchor">#</a> performWorkOnRoot</h3> <p>对需要处理的FiberRoot节点下的Fiber节点执行最终的renderRoot渲染阶段和completeRoot提交阶段</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>
    root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> <span class="token comment">// 执行更新的root节点</span>
    expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span> <span class="token comment">// 可更新的过期时间</span>
    isYieldy<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> <span class="token comment">// 是否异步调度: true异步 false同步或者root已经过期</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 标识目前已经开始进入渲染阶段</span>
    isRendering <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 表示同步任务或者任务已经过期  </span>

        <span class="token keyword">let</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断该root节点是否已经执行过renderRoot</span>
            <span class="token comment">// 由于completeRoot阶段会被打断,可能该root节点已经执行过renderRoot,避免性能浪费</span>
            <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 没有finishedWork标识就按照renderRoot -&gt; completeRoot的顺序执行 </span>
            <span class="token comment">// finishedWork表示root之前在completeRoot被挂起,需要清除</span>
            root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutHandle <span class="token operator">!==</span> noTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>
                <span class="token function">cancelTimeout</span><span class="token punctuation">(</span>timeoutHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> isYieldy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调度异步任务</span>
        <span class="token comment">// 处理的方式和同步方式基本一致, 只是在completeRoot的时候,需要检查一帧的时间是否有剩余</span>
        <span class="token keyword">let</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutHandle <span class="token operator">!==</span> noTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>
                <span class="token function">cancelTimeout</span><span class="token punctuation">(</span>timeoutHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> isYieldy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldYieldToRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 时间充足,直接调用completeRoot</span>
                    <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 时间不充足, 跳过, 设置renderRoot过的标识</span>
                    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 标识渲染阶段结束</span>
    isRendering <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h2 id="expirationtime-过期时间-优先级"><a href="#expirationtime-过期时间-优先级" class="header-anchor">#</a> ExpirationTime(过期时间&amp;优先级)</h2> <ol><li>获取currentTime,表示一个时间标识</li> <li>根据这个时间标识获取过期时间</li></ol> <h3 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h3> <p>调用requestCurrentTime来计算过期时间.
过期时间是通过将当前时间（开始时间）加起来得出的时间。 但是，如果在同一事件中安排了两次更新，即使实际时钟时间在第一次和第二次呼叫之间提前了，我们也应将它们的开始时间视为同时发生。
换句话说，由于到期时间决定了更新的批处理方式，因此我们希望在同一事件中发生的所有优先级相同的更新都收到相同的到期时间。
我们跟踪两个不同的时间：当前的“渲染器”时间和当前的“调度器”时间。 渲染器时间可以随时更新。 它只是为了最大程度地降低通话性能。但是，只有在没有待处理的工作，或者确定我们不在某个事件的中间时，才能更新调度程序时间。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="requestcurrenttime"><a href="#requestcurrenttime" class="header-anchor">#</a> requestCurrentTime</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// isRendering会在Schdule阶段中的performanceWorkOnRoot开始设置为true,结束设置为false</span>
   <span class="token comment">// true表示调度开始,直接返回之前的SchduleTime</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> currentSchedulerTime<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// Check if there's pending work.</span>
   <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>
           nextFlushedExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
           nextFlushedExpirationTime <span class="token operator">===</span> Never
   <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If there's no pending work, or if the pending work is offscreen, we can</span>
      <span class="token comment">// read the current time without risk of tearing.</span>
      <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>
      <span class="token keyword">return</span> currentSchedulerTime<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// There's already pending work. We might be in the middle of a browser</span>
   <span class="token comment">// event. If we were to read the current time, it could cause multiple updates</span>
   <span class="token comment">// within the same event to receive different expiration times, leading to</span>
   <span class="token comment">// tearing. Return the last read time. During the next idle callback, the</span>
   <span class="token comment">// time will be updated.</span>
   <span class="token keyword">return</span> currentSchedulerTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">currentSchedulerTime和currentRendererTime</p></div></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/19/2021, 10:37:21 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.bc936f00.js" defer></script><script src="/blog/assets/js/4.2ccc4457.js" defer></script><script src="/blog/assets/js/1.3d4d4d28.js" defer></script><script src="/blog/assets/js/51.912e8db1.js" defer></script>
  </body>
</html>
