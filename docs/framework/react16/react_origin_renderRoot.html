<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React源码-renderRoot | 小丑不哭</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="一只前端哈狗的开发日常">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.bb8e4b6a.css" as="style"><link rel="preload" href="/blog/assets/js/app.bc936f00.js" as="script"><link rel="preload" href="/blog/assets/js/4.2ccc4457.js" as="script"><link rel="preload" href="/blog/assets/js/1.3d4d4d28.js" as="script"><link rel="preload" href="/blog/assets/js/50.8eafa05e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.21421b3f.js"><link rel="prefetch" href="/blog/assets/js/11.465a3643.js"><link rel="prefetch" href="/blog/assets/js/12.5c15b4a0.js"><link rel="prefetch" href="/blog/assets/js/13.ef2df33e.js"><link rel="prefetch" href="/blog/assets/js/14.24545c08.js"><link rel="prefetch" href="/blog/assets/js/15.b64d08f3.js"><link rel="prefetch" href="/blog/assets/js/16.cd815414.js"><link rel="prefetch" href="/blog/assets/js/17.75ba5f7b.js"><link rel="prefetch" href="/blog/assets/js/18.a941584d.js"><link rel="prefetch" href="/blog/assets/js/19.774fbcfa.js"><link rel="prefetch" href="/blog/assets/js/20.984ca59d.js"><link rel="prefetch" href="/blog/assets/js/21.1e47c01c.js"><link rel="prefetch" href="/blog/assets/js/22.4ad9767a.js"><link rel="prefetch" href="/blog/assets/js/23.80a02068.js"><link rel="prefetch" href="/blog/assets/js/24.8fcb4240.js"><link rel="prefetch" href="/blog/assets/js/25.87fb2a64.js"><link rel="prefetch" href="/blog/assets/js/26.2b5af622.js"><link rel="prefetch" href="/blog/assets/js/27.9dd2f635.js"><link rel="prefetch" href="/blog/assets/js/28.620223b0.js"><link rel="prefetch" href="/blog/assets/js/29.b5132cc0.js"><link rel="prefetch" href="/blog/assets/js/30.e5fc9660.js"><link rel="prefetch" href="/blog/assets/js/31.cc3636e0.js"><link rel="prefetch" href="/blog/assets/js/32.07f2368f.js"><link rel="prefetch" href="/blog/assets/js/33.f322c3b4.js"><link rel="prefetch" href="/blog/assets/js/34.9dd28441.js"><link rel="prefetch" href="/blog/assets/js/35.26f89bd6.js"><link rel="prefetch" href="/blog/assets/js/36.0ad3ed5b.js"><link rel="prefetch" href="/blog/assets/js/37.a5beb387.js"><link rel="prefetch" href="/blog/assets/js/38.52cf41ae.js"><link rel="prefetch" href="/blog/assets/js/39.01010e58.js"><link rel="prefetch" href="/blog/assets/js/40.f8c98cc3.js"><link rel="prefetch" href="/blog/assets/js/41.8971de6f.js"><link rel="prefetch" href="/blog/assets/js/42.bcb81ef0.js"><link rel="prefetch" href="/blog/assets/js/43.4ad814a8.js"><link rel="prefetch" href="/blog/assets/js/44.c867afa4.js"><link rel="prefetch" href="/blog/assets/js/45.8c3374a3.js"><link rel="prefetch" href="/blog/assets/js/46.1db62c8f.js"><link rel="prefetch" href="/blog/assets/js/47.ac761158.js"><link rel="prefetch" href="/blog/assets/js/48.65ed8359.js"><link rel="prefetch" href="/blog/assets/js/49.eea27004.js"><link rel="prefetch" href="/blog/assets/js/5.36260e9d.js"><link rel="prefetch" href="/blog/assets/js/51.912e8db1.js"><link rel="prefetch" href="/blog/assets/js/52.c5c26bef.js"><link rel="prefetch" href="/blog/assets/js/53.3fb73f30.js"><link rel="prefetch" href="/blog/assets/js/54.52ecb194.js"><link rel="prefetch" href="/blog/assets/js/55.1fb9effa.js"><link rel="prefetch" href="/blog/assets/js/56.7e8e15e9.js"><link rel="prefetch" href="/blog/assets/js/57.c2c0eafb.js"><link rel="prefetch" href="/blog/assets/js/58.6fca8eea.js"><link rel="prefetch" href="/blog/assets/js/59.9ac5ca25.js"><link rel="prefetch" href="/blog/assets/js/6.3cb3a407.js"><link rel="prefetch" href="/blog/assets/js/60.44e53681.js"><link rel="prefetch" href="/blog/assets/js/61.10b13fbe.js"><link rel="prefetch" href="/blog/assets/js/62.915f77c6.js"><link rel="prefetch" href="/blog/assets/js/63.4d3cf238.js"><link rel="prefetch" href="/blog/assets/js/64.4cc47eb1.js"><link rel="prefetch" href="/blog/assets/js/65.1b03cbab.js"><link rel="prefetch" href="/blog/assets/js/66.3de2e01a.js"><link rel="prefetch" href="/blog/assets/js/67.027b34df.js"><link rel="prefetch" href="/blog/assets/js/68.a386474a.js"><link rel="prefetch" href="/blog/assets/js/69.aa4fa7ef.js"><link rel="prefetch" href="/blog/assets/js/7.6af1cf93.js"><link rel="prefetch" href="/blog/assets/js/70.9ec8a88a.js"><link rel="prefetch" href="/blog/assets/js/71.f609366f.js"><link rel="prefetch" href="/blog/assets/js/72.25b2daac.js"><link rel="prefetch" href="/blog/assets/js/73.48f3a309.js"><link rel="prefetch" href="/blog/assets/js/74.3f82cd07.js"><link rel="prefetch" href="/blog/assets/js/75.2f2bc274.js"><link rel="prefetch" href="/blog/assets/js/76.abc1534b.js"><link rel="prefetch" href="/blog/assets/js/77.49c8b0c5.js"><link rel="prefetch" href="/blog/assets/js/78.97ad82e2.js"><link rel="prefetch" href="/blog/assets/js/79.c64487b4.js"><link rel="prefetch" href="/blog/assets/js/8.259b9f4b.js"><link rel="prefetch" href="/blog/assets/js/80.556858e5.js"><link rel="prefetch" href="/blog/assets/js/81.0c11d233.js"><link rel="prefetch" href="/blog/assets/js/82.ac516c8e.js"><link rel="prefetch" href="/blog/assets/js/83.b1f34125.js"><link rel="prefetch" href="/blog/assets/js/84.0cef5ae7.js"><link rel="prefetch" href="/blog/assets/js/85.3efe19f7.js"><link rel="prefetch" href="/blog/assets/js/86.d258c1ee.js"><link rel="prefetch" href="/blog/assets/js/87.e3c49335.js"><link rel="prefetch" href="/blog/assets/js/88.d2bd0456.js"><link rel="prefetch" href="/blog/assets/js/89.35168226.js"><link rel="prefetch" href="/blog/assets/js/9.b95a6eec.js"><link rel="prefetch" href="/blog/assets/js/90.1f6c75a1.js"><link rel="prefetch" href="/blog/assets/js/91.6d7ddc82.js"><link rel="prefetch" href="/blog/assets/js/92.460ea3dc.js"><link rel="prefetch" href="/blog/assets/js/93.3068fe94.js"><link rel="prefetch" href="/blog/assets/js/94.e0b7832a.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.9459b9ea.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.bb8e4b6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>小丑不哭</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Jooker</span>
            
          <span data-v-64685f0e>2020 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="小丑不哭" class="logo"> <span class="site-name">小丑不哭</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/前端知识/" class="nav-link"><i class="iconfont undefined"></i>
  前端知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/原创文章/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/computer/" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/browser/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/js/" class="nav-link"><i class="iconfont undefined"></i>
  JS语法基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/native/" class="nav-link"><i class="iconfont undefined"></i>
  客户端基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/general/" class="nav-link"><i class="iconfont undefined"></i>
  通用编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  后端基础
</a></li><li class="dropdown-item"><h4>框架原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/docs/framework/react/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/react16/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  React16
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/docs/libs/" class="nav-link"><i class="iconfont undefined"></i>
  类库基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/engineer/" class="nav-link"><i class="iconfont undefined"></i>
  工程化体系
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/softSkill/" class="nav-link"><i class="iconfont undefined"></i>
  软技能
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/future/" class="nav-link"><i class="iconfont undefined"></i>
  前沿技术
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/math/" class="nav-link"><i class="iconfont undefined"></i>
  数学基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/article/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jo-ko" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://twitter.com/Jooker18506261" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-twitter"></i>
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="/blog/avatar.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    Jooker
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>58</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>10</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/前端知识/" class="nav-link"><i class="iconfont undefined"></i>
  前端知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/原创文章/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/computer/" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/browser/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/js/" class="nav-link"><i class="iconfont undefined"></i>
  JS语法基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/native/" class="nav-link"><i class="iconfont undefined"></i>
  客户端基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/general/" class="nav-link"><i class="iconfont undefined"></i>
  通用编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  后端基础
</a></li><li class="dropdown-item"><h4>框架原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/docs/framework/react/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/react16/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  React16
</a></li><li class="dropdown-subitem"><a href="/blog/docs/framework/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/docs/libs/" class="nav-link"><i class="iconfont undefined"></i>
  类库基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/engineer/" class="nav-link"><i class="iconfont undefined"></i>
  工程化体系
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/softSkill/" class="nav-link"><i class="iconfont undefined"></i>
  软技能
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/future/" class="nav-link"><i class="iconfont undefined"></i>
  前沿技术
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/math/" class="nav-link"><i class="iconfont undefined"></i>
  数学基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/docs/article/" class="nav-link"><i class="iconfont undefined"></i>
  原创文章
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jo-ko" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://twitter.com/Jooker18506261" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-twitter"></i>
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/blog/docs/framework/react16/" aria-current="page" class="sidebar-link">简述</a></li><li><a href="/blog/docs/framework/react16/react_origin_renderAndUpdate.html" class="sidebar-link">React16源码-render&amp;更新</a></li><li><a href="/blog/docs/framework/react16/react_origin_schedule.html" class="sidebar-link">React源码-schedule</a></li><li><a href="/blog/docs/framework/react16/react_origin_renderRoot.html" aria-current="page" class="active sidebar-link">React源码-renderRoot</a></li><li><a href="/blog/docs/framework/react16/react_origin_diff.html" class="sidebar-link">React源码-Diff</a></li><li><a href="/blog/docs/framework/react16/react_origin_completeWork.html" class="sidebar-link">React源码-completeWork</a></li><li><a href="/blog/docs/framework/react16/react_origin_completeRoot.html" class="sidebar-link">React源码-completeRoot</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>React源码-renderRoot</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Jooker</span>
            
          <span data-v-64685f0e>2020 - </span>
          2022
        </a></span></div></div> <div data-v-2d5f533b><main class="page"><div class="page-title" style="display:none;"><h1 class="title">React源码-renderRoot</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Jooker</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2020-03-11</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>框架基础</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>找出需要更新的节点,并打上标记,该阶段可以被打断</p></blockquote> <h2 id="renderroot"><a href="#renderroot" class="header-anchor">#</a> renderRoot</h2> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> isYieldy<span class="token operator">:</span> <span class="token type tag">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理useEffect</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用于标识开始renderRoot </span>
    isWorking <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousDispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span>

    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>nextExpirationTimeToWorkOn<span class="token punctuation">;</span>

    <span class="token comment">// 这里判断执行的任务是新任务还是之前被打断的任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        expirationTime <span class="token operator">!==</span> nextRenderExpirationTime <span class="token operator">||</span>
        root <span class="token operator">!==</span> nextRoot <span class="token operator">||</span>
        nextUnitOfWork <span class="token operator">===</span> <span class="token type tag">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里表示的是新任务,要重新初始化变量</span>
        <span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
        nextRenderExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token comment">// 这里比较关键,获取了workInProgress</span>
        <span class="token comment">// nextUnitOfWork就是current.alternate</span>
        nextUnitOfWork <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>
            nextRoot<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
            <span class="token type tag">null</span><span class="token punctuation">,</span>
            nextRenderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>pendingCommitExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
       
    <span class="token punctuation">}</span>


    <span class="token keyword">let</span> didFatal <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// dev环境调用,这里不考虑</span>
    <span class="token function">startWorkLoopTimer</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始执行workLoop</span>
    <span class="token comment">// 同时捕获错误,并执行对应的策略</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">workLoop</span><span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 出现错误要回滚</span>
            <span class="token function">resetContextDependences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resetHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 不存在nextUnitOfWork说明这是个无法预料的错误</span>
                <span class="token comment">// This is a fatal error.</span>
                didFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">onUncaughtError</span><span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 相反这是个可预期的错误</span>
                <span class="token keyword">const</span> sourceFiber<span class="token operator">:</span> Fiber <span class="token operator">=</span> nextUnitOfWork<span class="token punctuation">;</span>
                <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> sourceFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// root节点错误也作为无法预料的错误</span>
                    didFatal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">onUncaughtError</span><span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 处理Fiber抛出的错误</span>
                    <span class="token comment">// 第一种是throw promsie错误,suspense组件来处理</span>
                    <span class="token comment">// 第二种是组件真正的报错</span>
                    <span class="token function">throwException</span><span class="token punctuation">(</span>
                        root<span class="token punctuation">,</span>
                        returnFiber<span class="token punctuation">,</span>
                        sourceFiber<span class="token punctuation">,</span>
                        thrownValue<span class="token punctuation">,</span>
                        nextRenderExpirationTime<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 从当前节点向上处理父兄节点,完成打标记的过程</span>
                    nextUnitOfWork <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>sourceFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 标志performUnitOfWork和completeUnitWork的结束</span>
    <span class="token comment">// 重置变量</span>
    isWorking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> previousDispatcher<span class="token punctuation">;</span>
    <span class="token function">resetContextDependences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resetHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>didFatal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 表示有无法处理的错误,跳出当前调度进程,将权限交给宿主环境</span>
        <span class="token keyword">const</span> didCompleteRoot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span>interruptedBy<span class="token punctuation">,</span> didCompleteRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        interruptedBy <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        nextRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        <span class="token function">onFatal</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 表示还有异步调度任务,会在空闲的时候继续该任务</span>
        <span class="token keyword">const</span> didCompleteRoot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span>interruptedBy<span class="token punctuation">,</span> didCompleteRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        interruptedBy <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        <span class="token function">onYield</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 表示完成了所有的任务,重置参数</span>
    <span class="token keyword">const</span> didCompleteRoot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span>interruptedBy<span class="token punctuation">,</span> didCompleteRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rootWorkInProgress <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    nextRoot <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    interruptedBy <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在throwException中如果是组件本身错误导致的会将nextRenderDidError设置为true</span>
    <span class="token comment">// 先判断是否有优先级更低的任务，有的话把当前的渲染时间设置进suspendTime，调用onSuspend</span>
    <span class="token comment">// 如果不符合再判断帧时间超时并且不是root节点报错,是的话,设置root的expirationTime为同步最高优先级, 调用onSuspend</span>
    <span class="token comment">// 最终都会onSuspend,但其实是不会执行的,此时root.finishedWork === null, 返回上层函数performWorkOnRoot时也就不会执行completeRoot</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRenderDidError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasLowerPriorityWork</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">markSuspendedPriorityLevel</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> suspendedExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
            <span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
            <span class="token function">onSuspend</span><span class="token punctuation">(</span>
                root<span class="token punctuation">,</span>
                rootWorkInProgress<span class="token punctuation">,</span>
                suspendedExpirationTime<span class="token punctuation">,</span>
                rootExpirationTime<span class="token punctuation">,</span>
                <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token operator">!</span>root<span class="token punctuation">.</span>didError <span class="token operator">&amp;&amp;</span>
            isYieldy
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root<span class="token punctuation">.</span>didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> suspendedExpirationTime <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>nextExpirationTimeToWorkOn <span class="token operator">=</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">onSuspend</span><span class="token punctuation">(</span>
                root<span class="token punctuation">,</span>
                rootWorkInProgress<span class="token punctuation">,</span>
                suspendedExpirationTime<span class="token punctuation">,</span>
                rootExpirationTime<span class="token punctuation">,</span>
                <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 表示是suquense情况</span>
    <span class="token comment">// 计算调用timeout的调用时间(在timeout时间之后调用commit)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isYieldy <span class="token operator">&amp;&amp;</span> nextLatestAbsoluteTimeoutMs <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> suspendedExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token function">markSuspendedPriorityLevel</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> suspendedExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查找树中最早的未提交commit到期时间</span>
        <span class="token keyword">const</span> earliestExpirationTime <span class="token operator">=</span> <span class="token function">findEarliestOutstandingPriorityLevel</span><span class="token punctuation">(</span>
            root<span class="token punctuation">,</span>
            expirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> earliestExpirationTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>earliestExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earliestExpirationTimeMs <span class="token operator">&lt;</span> nextLatestAbsoluteTimeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextLatestAbsoluteTimeoutMs <span class="token operator">=</span> earliestExpirationTimeMs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// timeout = 超时时间 - 当前时间</span>
        <span class="token comment">// timeout小于零立即执行, 大于零调用定时器执行</span>
        <span class="token keyword">const</span> currentTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> msUntilTimeout <span class="token operator">=</span> nextLatestAbsoluteTimeoutMs <span class="token operator">-</span> currentTimeMs<span class="token punctuation">;</span>
        msUntilTimeout <span class="token operator">=</span> msUntilTimeout <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> msUntilTimeout<span class="token punctuation">;</span>

        <span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
        <span class="token function">onSuspend</span><span class="token punctuation">(</span>
            root<span class="token punctuation">,</span>
            rootWorkInProgress<span class="token punctuation">,</span>
            suspendedExpirationTime<span class="token punctuation">,</span>
            rootExpirationTime<span class="token punctuation">,</span>
            msUntilTimeout<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果以上的情况都不存在,直接结束renderRoot阶段 </span>
    <span class="token function">onComplete</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rootWorkInProgress<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过createWorkInProgress创建current.alternate属性workInProgress</span>
<span class="token comment">// current和workInProgress称为Fiber双缓存</span>
<span class="token comment">// 首次渲染的时候,只有root节点存在alternate, alertnate指向的Fiber是懒创建的</span>
<span class="token comment">// 在之后的更新中,如果节点只是更新属性的话,会重用fiber对象而不会再次创建,有利于节省空间</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// Fiber.current</span>
    pendingProps<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span> <span class="token comment">// 待更新的属性值</span>
    expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span> <span class="token comment">// 优先级</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
    <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不存在,需要新建一个</span>
        workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>
            current<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            pendingProps<span class="token punctuation">,</span>
            current<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
            current<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">=</span> current<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
        current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存在,复用更新属性</span>
        workInProgress<span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下面属性需要全部重新赋值</span>
    workInProgress<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> current<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>contextDependencies <span class="token operator">=</span> current<span class="token punctuation">.</span>contextDependencies<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>sibling <span class="token operator">=</span> current<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>index <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>ref <span class="token operator">=</span> current<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>

    <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br></div></div><h2 id="workloop-performunitofwork"><a href="#workloop-performunitofwork" class="header-anchor">#</a> workLoop &amp;&amp; performUnitOfWork</h2> <ol><li>workLoop根据传入的isYieldy参数来判断performUnitOfWork执行的时机</li> <li>performUnitOfWork调用beginWork更新任务节点, 遇到叶子节点调用completeUnitOfWork完成更新</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同步或者过期 直接调用performUnitOfWork</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异步 检查一帧是否有空闲时间</span>
        <span class="token comment">// 有空闲的时间再执行performUnitOfWork</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYieldToRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token function">startWorkTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextRenderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明到达叶子节点</span>
        next <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="beginwork"><a href="#beginwork" class="header-anchor">#</a> beginWork</h2> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span> <span class="token comment">// nextExpirationTimeToWorkOn 执行更新的优先级</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一般情况下,无论初次挂载还是更新都会走这个分支的逻辑</span>
        <span class="token comment">// 初始化的时候,下面的分支都不会走</span>
        <span class="token comment">// 更新的时候会判断是否需要更新, 判断条件:</span>
        <span class="token comment">//  1. 前后props不相等</span>
        <span class="token comment">//  2. 使用老版本的context并发生了变化</span>
        <span class="token comment">// 如果不需要更新,调用bailoutOnAlreadyFinishedWork复用节点,同时更新当前的context上下文</span>
        <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
        <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//... </span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
                current<span class="token punctuation">,</span>
                workInProgress<span class="token punctuation">,</span>
                renderExpirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>

    <span class="token comment">// 判断Fiber的节点类型,执行对应的更新</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// FunctionComponent在首次创建的时候的tag类型默认是IndeterminateComponent</span>
        <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 懒加载组件</span>
        <span class="token keyword">case</span> LazyComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 函数组件</span>
        <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 类组件</span>
        <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 根节点</span>
        <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// 原生标签节点</span>
        <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// 原生文本节点</span>
        <span class="token keyword">case</span> HostText<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// suspense组件 与LazyComponent配合使用, 异步组件</span>
        <span class="token keyword">case</span> SuspenseComponent<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// portal组件</span>
        <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// 通过React.forwardRef创造的组件</span>
        <span class="token keyword">case</span> ForwardRef<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// React.Fragment组件</span>
        <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// React.unstable_AsyncMode组件,表示异步渲染</span>
        <span class="token keyword">case</span> Mode<span class="token operator">:</span>
            <span class="token comment">// ...</span>
        <span class="token comment">// React.Profiler组件,检测性能</span>
        <span class="token keyword">case</span> Profiler<span class="token operator">:</span>
        <span class="token comment">// context状态提供组件</span>
        <span class="token keyword">case</span> ContextProvider<span class="token operator">:</span>
            <span class="token comment">// ... </span>
        <span class="token comment">//  context状态消费组件</span>
        <span class="token keyword">case</span> ContextConsumer<span class="token operator">:</span>
            <span class="token comment">// ... </span>
        <span class="token comment">// React.memo 组件 与LazyComponent配合使用, 异步组件</span>
        <span class="token comment">// 添加自定义定比较方法    </span>
        <span class="token keyword">case</span> MemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// React.memo 组件 与LazyComponent配合使用, 异步组件</span>
        <span class="token comment">// 未添加自定义定比较方法    </span>
        <span class="token keyword">case</span> SimpleMemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 与SuspenseComponent配合使用, 异步组件</span>
        <span class="token keyword">case</span> IncompleteClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
           <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 与SuspenseComponent配合使用, 异步组件</span>
        <span class="token keyword">case</span> DehydratedSuspenseComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><h2 id="节点类型更新"><a href="#节点类型更新" class="header-anchor">#</a> 节点类型更新</h2> <h3 id="classcomponent"><a href="#classcomponent" class="header-anchor">#</a> ClassComponent</h3> <ol><li>合并defaultProps和传入的props</li> <li>根据当前实例状态执行不同的状态函数</li> <li>判断是否更新,返回子节点</li></ol> <div class="custom-block tip"><p class="custom-block-title">流程</p> <img src="/blog/frameWork/react_origin_renderRoot_beginWork_updateClassComponent.png" alt="react_origin_renderRoot_beginWork_updateComponent"></div> <p><strong>源码</strong></p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">;</span>
        <span class="token comment">// 待更新的props</span>
        <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
        <span class="token comment">// resolveDefaultProps 其实就是把更新的props 加上 Component.defaultProps</span>
        <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
            workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
                <span class="token operator">?</span> unresolvedProps
                <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            resolvedProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    Component<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    nextProps<span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 用于处理context</span>
    <span class="token keyword">let</span> hasContext<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        hasContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取Class实例</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">let</span> shouldUpdate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次挂载</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// instance为null的时候,current应该也是null</span>
            <span class="token comment">// 只有在suspend渲染的情况下会出现</span>
            current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
            workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建该节点实例</span>
        <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            nextProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment">// 挂载该节点实例</span>
        <span class="token comment">// 调用挂载生命周期</span>
        <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            nextProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 组件被中断渲染了,有实例但是没有current,复用之前的实例,调用挂载生命周期</span>
        shouldUpdate <span class="token operator">=</span> <span class="token function">resumeMountClassInstance</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            nextProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 组件更新, 调用更新生命周期</span>
        shouldUpdate <span class="token operator">=</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            nextProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否执行render或者跳过更新, 并返回 render 下的第一个 child</span>
    <span class="token keyword">const</span> nextUnitOfWork <span class="token operator">=</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        shouldUpdate<span class="token punctuation">,</span>
        hasContext<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> nextUnitOfWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><h4 id="constructclassinstance"><a href="#constructclassinstance" class="header-anchor">#</a> constructClassInstance</h4> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    ctor<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isLegacyContextConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> unmaskedContext <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>


    <span class="token comment">// 这块是处理context</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>contextType<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> contextTypes <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextTypes<span class="token punctuation">;</span>
        isLegacyContextConsumer <span class="token operator">=</span>
            contextTypes <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> contextTypes <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        context <span class="token operator">=</span> isLegacyContextConsumer
            <span class="token operator">?</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span>
            <span class="token operator">:</span> emptyContextObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 实例化类对象</span>
    <span class="token comment">// 传入两个参数props和context</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取实例的state属性</span>
    <span class="token comment">// 赋值state(workInProgress.memoizedState = !isUndef(instance.state) || null)</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span>
        instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span>
            <span class="token operator">?</span> instance<span class="token punctuation">.</span>state
            <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 挂载当前实例到Fiber节点上</span>
    <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// context缓存 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLegacyContextConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cacheContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> instance<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在这里设置了updater属性 this.updater.setState</span>
    instance<span class="token punctuation">.</span>updater <span class="token operator">=</span> classComponentUpdater<span class="token punctuation">;</span>
    <span class="token comment">// workInProgress上挂载instance</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
    <span class="token comment">// instance上挂载workInProgress</span>
    <span class="token function">setInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">问: updater属性是何时被添加的?</p> <p>在创建实例化的时候调用adoptClassInstance,将classComponentUpdater挂载到updater属性上</p></div> <h4 id="mountclassinstance"><a href="#mountclassinstance" class="header-anchor">#</a> mountClassInstance</h4> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    ctor<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    newProps<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">void</span> <span class="token punctuation">{</span>

    <span class="token comment">// 实例属性挂载</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyRefsObject<span class="token punctuation">;</span>

    <span class="token comment">// context属性挂载</span>
    <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span>contextType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取updateQueue并计算更新队列,获取最后的state</span>
    <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            updateQueue<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
            instance<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调用getDerivedStateFromProps钩子并设置新的state</span>
    <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            ctor<span class="token punctuation">,</span>
            getDerivedStateFromProps<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里调用之后会在新版本中移除的生命周期钩子方法</span>
    <span class="token comment">// UNSAFE_componentWillMount(componentWillMount)</span>
    <span class="token comment">// componentWillMount这个方法的调用只有在getDerivedStateFromProps和getSnapshotBeforeUpdate都不存在时调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
            <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callComponentWillMount</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新计算下state </span>
        updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
                workInProgress<span class="token punctuation">,</span>
                updateQueue<span class="token punctuation">,</span>
                newProps<span class="token punctuation">,</span>
                instance<span class="token punctuation">,</span>
                renderExpirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 这里做了标记,当挂载到真实节点上会触发该生命周期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h4 id="resumemountclassinstance"><a href="#resumemountclassinstance" class="header-anchor">#</a> resumeMountClassInstance</h4> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">resumeMountClassInstance</span><span class="token punctuation">(</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    ctor<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    newProps<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">boolean</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例props属性挂载</span>
    <span class="token comment">// context相关</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> oldProps<span class="token punctuation">;</span>

    <span class="token keyword">const</span> oldContext <span class="token operator">=</span> instance<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
    <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextContext<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextContext <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span>contextType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> nextLegacyUnmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            ctor<span class="token punctuation">,</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextContext <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> nextLegacyUnmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里判断是否执行getDerivedStateFromProps</span>
    <span class="token comment">// 和之前一样,如果有新的生命周期钩子就不会执行</span>
    <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hasNewLifecycles <span class="token operator">=</span>
        <span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
            <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> oldContext <span class="token operator">!==</span> nextContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callComponentWillReceiveProps</span><span class="token punctuation">(</span>
                workInProgress<span class="token punctuation">,</span>
                instance<span class="token punctuation">,</span>
                newProps<span class="token punctuation">,</span>
                nextContext<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置了hasForceUpdate = false</span>
    <span class="token function">resetHasForceUpdateBeforeProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取了updateQueue并计算最后的state</span>
    <span class="token keyword">const</span> oldState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            updateQueue<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
            instance<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">// 当重新挂载的时候state, props, context都没变就返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        oldProps <span class="token operator">===</span> newProps <span class="token operator">&amp;&amp;</span>
        oldState <span class="token operator">===</span> newState <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">checkHasForceUpdateAfterProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调用了getDerivedStateFromProps需要重新计算state</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            ctor<span class="token punctuation">,</span>
            getDerivedStateFromProps<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断是否需要更新</span>
    <span class="token comment">// 如果存在shouldCompoentDidUpdate,就调用函数判断</span>
    <span class="token comment">// 如果是pureComponent,会进行浅比较</span>
    <span class="token keyword">const</span> shouldUpdate <span class="token operator">=</span>
        <span class="token function">checkHasForceUpdateAfterProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">checkShouldComponentUpdate</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            ctor<span class="token punctuation">,</span>
            oldProps<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
            oldState<span class="token punctuation">,</span>
            newState<span class="token punctuation">,</span>
            nextContext<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 有更新就需要判断componentWillMount是否执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
                <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startPhaseTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> <span class="token string">'componentWillMount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">UNSAFE_componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">stopPhaseTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 标记componentDidMount，中断的组件仍然按照首次挂载执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 更新props和props</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> nextContext<span class="token punctuation">;</span>

    <span class="token keyword">return</span> shouldUpdate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br></div></div><h4 id="updateclassinstance"><a href="#updateclassinstance" class="header-anchor">#</a> updateClassInstance</h4> <p>整个过程和resumeClassInstance基本一致,不同的是执行对应的生命周期, 标记 didUpdate, getSnapshotBeforeUpdate</p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    ctor<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    newProps<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">boolean</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        oldProps <span class="token operator">===</span> newProps <span class="token operator">&amp;&amp;</span>
        oldState <span class="token operator">===</span> newState <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">checkHasForceUpdateAfterProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                oldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
                oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                oldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
                oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里判断执行的是componentWillUpdate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
                <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startPhaseTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> <span class="token string">'componentWillUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">stopPhaseTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                oldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
                oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                oldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
                oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h4 id="finishclasscomponent"><a href="#finishclasscomponent" class="header-anchor">#</a> finishClassComponent</h4> <ol><li>调用render方法</li> <li>调用reconcileChildFibers将ReactElement转为Fiber,进行调和Diff</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    Component<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    shouldUpdate<span class="token operator">:</span> <span class="token type tag">boolean</span><span class="token punctuation">,</span>
    hasContext<span class="token operator">:</span> <span class="token type tag">boolean</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 标记ref标志</span>
    <span class="token function">markRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> didCaptureError <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">;</span>

    <span class="token comment">// 如果不需要更新并且没有错误捕获就复用节点返回子节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldUpdate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// context相关</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

    <span class="token comment">// Rerender</span>
    ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        didCaptureError <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> Component<span class="token punctuation">.</span>getDerivedStateFromError <span class="token operator">!==</span> <span class="token string">'function'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果捕获错误,并且没有getDerivedStateFromError,就卸载子组件</span>
        nextChildren <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要更新且不报错就调用实例的render方法获得最新的 nextChildren, </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// devtool相关标识</span>
    workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> PerformedWork<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有错误重新计算children</span>
        <span class="token comment">// 最终调用的还是reconcilerChildrenFibers</span>
        <span class="token function">forceUnmountCurrentAndReconcile</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算children将ReactElement转成Fiber</span>
        <span class="token comment">// 最终调用的是reconcileChildFibers</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> instance<span class="token punctuation">.</span>state<span class="token punctuation">;</span>

    <span class="token comment">// 如果存在context需要重新计算状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><h3 id="functioncomponent"><a href="#functioncomponent" class="header-anchor">#</a> FunctionComponent</h3> <ol><li>执行function函数和hooks钩子</li> <li>调用reconcileChildFibers将ReactElement转为Fiber,进行调和Diff</li></ol> <div class="custom-block tip"><p class="custom-block-title">流程</p> <img src="/blog/frameWork/react_origin_renderRoot_beginWork_updateFunctionComponent.png" alt="react_origin_renderRoot_beginWork_updateComponent"></div> <p><strong>源码</strong></p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
        <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
            workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
                <span class="token operator">?</span> unresolvedProps
                <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            resolvedProps<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...    </span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    nextProps<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// context相关</span>
    <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
    <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理函数组件中的hooks</span>
        <span class="token comment">// 调用函数获取对应的ReactElement同时处理hooks</span>
        nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            nextProps<span class="token punctuation">,</span>
            context<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didReceiveUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 表示非首次挂载并且未更新数据</span>
        <span class="token comment">// 复用节点</span>
        <span class="token function">bailoutHooks</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> PerformedWork<span class="token punctuation">;</span>
    <span class="token comment">// 将ReactElement转为Fiber,提供Diff</span>
    <span class="token comment">// 函数返回值赋值给workInProgress.child</span>
    <span class="token comment">// 最终调用的是reconcileChildFibers</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        nextChildren<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h4 id="renderwithhooks"><a href="#renderwithhooks" class="header-anchor">#</a> renderWithHooks</h4> <blockquote><p>renderWithHooks主要处理了新增的hooks钩子的逻辑</p></blockquote> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    Component<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    refOrContext<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">,</span>
    nextRenderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token type tag">any</span> <span class="token punctuation">{</span>
    renderExpirationTime <span class="token operator">=</span> nextRenderExpirationTime<span class="token punctuation">;</span>
    <span class="token comment">// 当前真要渲染的Fiber对象</span>
    currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    <span class="token comment">// 这块memoizedState就是我们调用useState Hook对象</span>
    nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用来存放 useState、useEffect 等 hook 函数的调用对象</span>
        <span class="token comment">// 首次渲染使用的是 HooksDispatcherOnMount</span>
        <span class="token comment">// 之后更新使用的是 HooksDispatcherOnUpdate</span>
        ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
            nextCurrentHook <span class="token operator">===</span> <span class="token type tag">null</span>
                <span class="token operator">?</span> HooksDispatcherOnMount
                <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行Function获取return返回的节点信息</span>
    <span class="token comment">// 可以看到函数组件传入的第一个参数是props,第二个参数是context</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当触发更新时,执行一次循环, 重新调用函数计算children</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//记录渲染次数 </span>
            numberOfReRenders <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
            nextWorkInProgressHook <span class="token operator">=</span> firstWorkInProgressHook<span class="token punctuation">;</span>

            currentHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
            workInProgressHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
            componentUpdateQueue <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>


            ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> __DEV__
                <span class="token operator">?</span> HooksDispatcherOnUpdateInDEV
                <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>

            children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>

        renderPhaseUpdates <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        numberOfReRenders <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 阻止hooks在函数外使用</span>
    <span class="token comment">// 只有在函数内执行dispatcher才会被赋予正确的环境值</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span>

    <span class="token keyword">const</span> renderedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>currentlyRenderingFiber<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 为当前的workInProgress设置相关属性</span>
    renderedWork<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> firstWorkInProgressHook<span class="token punctuation">;</span>
    renderedWork<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> remainingExpirationTime<span class="token punctuation">;</span>
    renderedWork<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token punctuation">(</span>componentUpdateQueue<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderedWork<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> sideEffectTag<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> didRenderTooFewHooks <span class="token operator">=</span>
        currentHook <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> currentHook<span class="token punctuation">.</span>next <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 重置全局属性</span>
    renderExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
    currentlyRenderingFiber <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    currentHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    nextCurrentHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    firstWorkInProgressHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    workInProgressHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    nextWorkInProgressHook <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    remainingExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
    componentUpdateQueue <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    sideEffectTag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h3 id="indeterminatecomponent"><a href="#indeterminatecomponent" class="header-anchor">#</a> IndeterminateComponent</h3> <blockquote><p>组件首次渲染的默认类型,在第一次渲染后会确定具体类型</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">流程</p> <img src="/blog/frameWork/react_origin_renderRoot_beginWork_IndeterminateComponent.png" alt="react_origin_renderRoot_beginWork_IndeterminateComponent"></div> <p><strong>源码</strong></p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
    _current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_current <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果出现了_current参数,说明渲染时有Suspend的情况</span>
        _current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> props <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token comment">// 下面是和context相关,设置节点读取context的范围</span>
    <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> value<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// renderWithHooks是用于处理函数式组件的hook</span>
        <span class="token comment">// 同时返回函数return的对象</span>
        value <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
            <span class="token type tag">null</span><span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            props<span class="token punctuation">,</span>
            context<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 根据value判断Fiber类型是FunctionComponent还是ClassComponent</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
        value <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>render <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        value<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里判断返回的值有render属性就是ClassComponent类型</span>
        workInProgress<span class="token punctuation">.</span>tag <span class="token operator">=</span> ClassComponent<span class="token punctuation">;</span>

        <span class="token comment">// ClassComponent类型无法使用Hook,因此要清理</span>
        <span class="token function">resetHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 下面的逻辑就是updateClassComponent的逻辑</span>
        <span class="token keyword">let</span> hasContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hasContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            hasContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span>
            value<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> value<span class="token punctuation">.</span>state <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> Component<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
                workInProgress<span class="token punctuation">,</span>
                Component<span class="token punctuation">,</span>
                getDerivedStateFromProps<span class="token punctuation">,</span>
                props<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> props<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
            <span class="token type tag">null</span><span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            Component<span class="token punctuation">,</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span>
            hasContext<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 下面是updateFunctionComponent的处理逻辑</span>
        workInProgress<span class="token punctuation">.</span>tag <span class="token operator">=</span> FunctionComponent<span class="token punctuation">;</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token type tag">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> value<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><h3 id="hostroot"><a href="#hostroot" class="header-anchor">#</a> HostRoot</h3> <blockquote><p>ReactDOM.render为Root节点的创建update</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">流程</p> <img src="/blog/frameWork/react_origin_renderRoot_beginWork_hostRoot.png" alt="react_origin_renderRoot_beginWork_hostRoot"></div> <p><strong>源码</strong></p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code>
<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// context相关</span>
    <span class="token function">pushHostRootContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevChildren <span class="token operator">=</span> prevState <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">?</span> prevState<span class="token punctuation">.</span>element <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取新的state</span>
    <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        updateQueue<span class="token punctuation">,</span>
        nextProps<span class="token punctuation">,</span>
        <span class="token type tag">null</span><span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token comment">// React DevTool依赖element这个属性</span>
    <span class="token keyword">const</span> nextChildren <span class="token operator">=</span> nextState<span class="token punctuation">.</span>element<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChildren <span class="token operator">===</span> prevChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新老state相同就会复用原来节点  </span>
        <span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> root<span class="token operator">:</span> FiberRoot <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token type tag">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        root<span class="token punctuation">.</span>hydrate <span class="token operator">&amp;&amp;</span>
        <span class="token function">enterHydrationState</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次挂载,设置更新标识符 </span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>

        <span class="token comment">// 这块和前面很像,最终进入reconcileChildFibers Diff</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            <span class="token type tag">null</span><span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新,进行reconcileChildFibers Diff</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
            current<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="hostcomponent"><a href="#hostcomponent" class="header-anchor">#</a> HostComponent</h3> <blockquote><p>该类型表示的是原生节点(div,h1...)</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">流程</p> <img src="/blog/frameWork/react_origin_renderRoot_beginWork_hostComponent.png" alt="react_origin_renderRoot_beginWork_hostComponent"></div> <p><strong>源码</strong></p> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code>
<span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// context相关</span>
    <span class="token function">pushHostContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这块和服务端渲染有关,判断是否能够复用 </span>
        <span class="token function">tryToClaimNextHydratableInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">type</span> <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">:</span> <span class="token type tag">null</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> nextChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token comment">//shouldSetTextContent返回true的条件, 满足下面三个条件之一</span>
    <span class="token comment">// 节点在(textarea, option, noscript) 之中</span>
    <span class="token comment">// 节点的子元素是字符串或者数字类型</span>
    <span class="token comment">// 存在dangerouslySetInnerHTML属性</span>
    <span class="token keyword">const</span> isDirectTextChild <span class="token operator">=</span> <span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectTextChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dom标签内是纯文本,直接渲染文本内容</span>
        nextChildren <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prevProps <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 之前是文本节点现在不是,打上标记</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> ContentReset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 只有在hostComponent和hostText中使用markRef</span>
    <span class="token comment">// 如果存在ref属性,打上ref标记  </span>
    <span class="token function">markRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        renderExpirationTime <span class="token operator">!==</span> Never <span class="token operator">&amp;&amp;</span>
        workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode <span class="token operator">&amp;&amp;</span>
        <span class="token function">shouldDeprioritizeSubtree</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// concurrentMode下设置过期时间为Never,优先级最低</span>
        workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> Never<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最终还是调用reconcileChildren进行Diff</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        nextChildren<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="hosttext"><a href="#hosttext" class="header-anchor">#</a> HostText</h3> <blockquote><p>纯文本节点</p></blockquote> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否可以复用服务端的渲染</span>
        <span class="token function">tryToClaimNextHydratableInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 直接渲染,不需要调和 </span>
    <span class="token keyword">return</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="suspensecomponent"><a href="#suspensecomponent" class="header-anchor">#</a> SuspenseComponent</h3> <blockquote><p>react16新增的组件类型, 作用是异步操作的UI逻辑解耦</p></blockquote> <ol><li>判断组件是否获取到异常(reject/promise),</li> <li>捕获到异常渲染fallback节点</li> <li>没有捕获到渲染最终节点</li> <li>最终还是通过reconcileChildFibers进行调和diff</li></ol> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code>
<span class="token keyword">function</span> <span class="token function">updateSuspenseComponent</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mode <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>mode<span class="token punctuation">;</span>
    <span class="token comment">// fallback&amp;children</span>
    <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextState<span class="token operator">:</span> SuspenseState <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

    <span class="token comment">// 用于判断Suspense是否超时了, 超时就显示fallback的内容</span>
    <span class="token comment">// 这块的超时指的是是否捕获到了错误</span>
    <span class="token keyword">let</span> nextDidTimeout<span class="token punctuation">;</span>
    <span class="token comment">// 判断是否抛出reject或者promise</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">===</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没抛出</span>
        nextState <span class="token operator">=</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        nextDidTimeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 抛出了</span>
        nextState <span class="token operator">=</span> <span class="token punctuation">{</span>
            timedOutAt<span class="token operator">:</span> nextState <span class="token operator">!==</span> <span class="token type tag">null</span> <span class="token operator">?</span> nextState<span class="token punctuation">.</span>timedOutAt <span class="token operator">:</span> NoWork<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        nextDidTimeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>DidCapture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> child<span class="token punctuation">;</span>
    <span class="token keyword">let</span> next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 刚初始化挂载 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextDidTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 触发第一次throw promise时触发,pendding状态</span>
            <span class="token comment">// 通过fallback创建子节点</span>
            <span class="token keyword">const</span> nextFallbackChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>fallback<span class="token punctuation">;</span>
            <span class="token comment">// 创建Fragment类型的fiber,用于保存最终渲染的节点</span>
            <span class="token keyword">const</span> primaryChildFragment <span class="token operator">=</span> <span class="token function">createFiberFromFragment</span><span class="token punctuation">(</span>
                <span class="token type tag">null</span><span class="token punctuation">,</span>
                mode<span class="token punctuation">,</span>
                NoWork<span class="token punctuation">,</span>
                <span class="token type tag">null</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 保存最终渲染节点的子节点信息</span>
                <span class="token keyword">const</span> progressedState<span class="token operator">:</span> SuspenseState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
                <span class="token keyword">const</span> progressedPrimaryChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token operator">=</span>
                    progressedState <span class="token operator">!==</span> <span class="token type tag">null</span>
                        <span class="token operator">?</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>child<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>child
                        <span class="token operator">:</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>child<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                primaryChildFragment<span class="token punctuation">.</span>child <span class="token operator">=</span> progressedPrimaryChild<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 为fallback创建节点</span>
            <span class="token keyword">const</span> fallbackChildFragment <span class="token operator">=</span> <span class="token function">createFiberFromFragment</span><span class="token punctuation">(</span>
                nextFallbackChildren<span class="token punctuation">,</span>
                mode<span class="token punctuation">,</span>
                renderExpirationTime<span class="token punctuation">,</span>
                <span class="token type tag">null</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            primaryChildFragment<span class="token punctuation">.</span>sibling <span class="token operator">=</span> fallbackChildFragment<span class="token punctuation">;</span>
            child <span class="token operator">=</span> primaryChildFragment<span class="token punctuation">;</span>
            next <span class="token operator">=</span> fallbackChildFragment<span class="token punctuation">;</span>
            child<span class="token punctuation">.</span>return <span class="token operator">=</span> next<span class="token punctuation">.</span>return <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始化Suspense的时候触发</span>
            <span class="token comment">// 所以一开始会走这个逻辑,再走上面的逻辑</span>
            <span class="token keyword">const</span> nextPrimaryChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
            child <span class="token operator">=</span> next <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
                workInProgress<span class="token punctuation">,</span>
                <span class="token type tag">null</span><span class="token punctuation">,</span>
                nextPrimaryChildren<span class="token punctuation">,</span>
                renderExpirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新阶段, throw reject或者返回结果的时候 </span>
        <span class="token comment">// prevState 会携带timedOutAt属性</span>
        <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
        <span class="token keyword">const</span> prevDidTimeout <span class="token operator">=</span> prevState <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevDidTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 表示之前已经抛出异常 </span>
            <span class="token keyword">const</span> currentPrimaryChildFragment<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>child<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> currentFallbackChildFragment<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>currentPrimaryChildFragment<span class="token punctuation">.</span>sibling<span class="token operator">:</span> <span class="token type tag">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextDidTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 还是有异常抛出, 复用之前的主要节点</span>
                <span class="token keyword">const</span> nextFallbackChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>fallback<span class="token punctuation">;</span>
                <span class="token keyword">const</span> primaryChildFragment <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>
                    currentPrimaryChildFragment<span class="token punctuation">,</span>
                    currentPrimaryChildFragment<span class="token punctuation">.</span>pendingProps<span class="token punctuation">,</span>
                    NoWork<span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ...</span>
                <span class="token comment">// 渲染fallback节点, 跳过主要节点 </span>
                next <span class="token operator">=</span> fallbackChildFragment<span class="token punctuation">;</span>
                child<span class="token punctuation">.</span>return <span class="token operator">=</span> next<span class="token punctuation">.</span>return <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 表示结束了suspense, 状态返回了真实数据,而不是抛出异常</span>
                <span class="token comment">// 渲染真实节点</span>
                <span class="token keyword">const</span> nextPrimaryChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
                <span class="token keyword">const</span> currentPrimaryChild <span class="token operator">=</span> currentPrimaryChildFragment<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
                <span class="token keyword">const</span> primaryChild <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
                    workInProgress<span class="token punctuation">,</span>
                    currentPrimaryChild<span class="token punctuation">,</span>
                    nextPrimaryChildren<span class="token punctuation">,</span>
                    renderExpirationTime<span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                child <span class="token operator">=</span> next <span class="token operator">=</span> primaryChild<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> nextState<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><h2 id="节点复用"><a href="#节点复用" class="header-anchor">#</a> 节点复用</h2> <div class="language-flow js line-numbers-mode"><pre class="language-flow"><code>
<span class="token keyword">function</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
    current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span><span class="token punctuation">,</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token type tag">null</span> <span class="token punctuation">{</span>
    <span class="token function">cancelWorkTimer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token type tag">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Reuse previous context list</span>
        workInProgress<span class="token punctuation">.</span>contextDependencies <span class="token operator">=</span> current<span class="token punctuation">.</span>contextDependencies<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Don't update &quot;base&quot; render times for bailouts.</span>
        <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if the children have any pending work.</span>
    <span class="token keyword">const</span> childExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The children don't have any work either. We can skip them.</span>
        <span class="token comment">// TODO: Once we add back resuming, we should check if the children are</span>
        <span class="token comment">// a work-in-progress set. If so, we need to transfer their effects.</span>
        <span class="token keyword">return</span> <span class="token type tag">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// This fiber doesn't have work, but its subtree does. Clone the child</span>
        <span class="token comment">// fibers and continue.</span>
        <span class="token function">cloneChildFibers</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/19/2021, 10:37:21 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.bc936f00.js" defer></script><script src="/blog/assets/js/4.2ccc4457.js" defer></script><script src="/blog/assets/js/1.3d4d4d28.js" defer></script><script src="/blog/assets/js/50.8eafa05e.js" defer></script>
  </body>
</html>
