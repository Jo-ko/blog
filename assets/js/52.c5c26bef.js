(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{599:function(t,a,s){"use strict";s.r(a);var n=s(3),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"react15"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react15"}},[t._v("#")]),t._v(" React15")]),t._v(" "),s("h3",{attrs:{id:"reconciler-stack-reconciler协调器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-stack-reconciler协调器"}},[t._v("#")]),t._v(" "),s("strong",[t._v("Reconciler(Stack Reconciler协调器)")])]),t._v(" "),s("blockquote",[s("p",[t._v("执行虚拟dom到真实dom的协调映射, 包括组件的挂载,更新和卸载(由于该过程中涉及diff算法的调用,我们常常以为reconciler===diff, 但其实diff只是其中的一环)")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("执行过程")]),t._v(" "),s("ol",[s("li",[t._v("通过调用this.setState、this.forceUpdate、ReactDom.render等API触发")]),t._v(" "),s("li",[t._v("调用函数组件、或class组件的render方法，将返回的JSX转化为虚拟DOM,各个元素和父子组件通过 "),s("strong",[t._v("树型结构")]),t._v(" 连接")]),t._v(" "),s("li",[t._v("通过 "),s("strong",[t._v("深度优先遍历递归方式")]),t._v(" 将虚拟DOM和上次更新时的虚拟DOM对比, 由于是采用栈递归的方式,导致 "),s("strong",[t._v("整个任务无法中断")])]),t._v(" "),s("li",[t._v("通过diff对比找出本次更新中变化的虚拟DOM")]),t._v(" "),s("li",[t._v("通过对比找出本次更新中变化的虚拟DOM")])])]),t._v(" "),s("h3",{attrs:{id:"render-渲染器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#render-渲染器"}},[t._v("#")]),t._v(" "),s("strong",[t._v("Render(渲染器)")])]),t._v(" "),s("blockquote",[s("p",[t._v("执行最终的宿主环境渲染呈现,将渲染器脱离,来适应不同平台的需求")])]),t._v(" "),s("ol",[s("li",[t._v("react-dom: 浏览器环境渲染")]),t._v(" "),s("li",[t._v("react-native-renderer: RN环境渲染")]),t._v(" "),s("li",[t._v("react-art: canvas, SVG, VML渲染")])]),t._v(" "),s("h3",{attrs:{id:"相关知识点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#相关知识点"}},[t._v("#")]),t._v(" 相关知识点")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("事务机制")]),t._v(" "),s("ol",[s("li",[t._v("Transaction创建一个黑盒子，它能够包装任何方法，以便在调用方法之前和之后维护某些不变量(即使在调用包装方法时抛出异常)")]),t._v(" "),s("li",[t._v("react事务机制的生命周期包括四个部分:perform, initialize, method, close")]),t._v(" "),s("li",[t._v("通过继承重写getTransactionWrappers方法,返回事务执行的wrapper")]),t._v(" "),s("li",[t._v("perform调用后会在执行所有的wrapper的initialize方法,再执行传入的method方法, 最后执行所有wapper的close方法")]),t._v(" "),s("li",[t._v("perform方法会通过invariant来保证不执行当前正在执行的事务")]),t._v(" "),s("li",[t._v("使用一个临时变量来标记当前的执行过程是否有异常(用于报错时能够更好的找到出错地方), initialize, method出错会始终执行close方法")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("batchedUpdates(批量更新)")]),t._v(" "),s("ol",[s("li",[t._v("批量更新依靠的是 "),s("strong",[t._v("事务机制(批量更新事务部分)")])]),t._v(" "),s("li",[t._v("react会在"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/bdf263625db59f54368d39e8ef077e7f0e9313db/src/renderers/dom/client/ReactMount.js#L383",target:"_blank",rel:"noopener noreferrer"}},[t._v("首次渲染组件"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/911603b46e89ae0704561a2ad9a8cbd7f2bc12f1/src/renderers/dom/client/ReactEventListener.js#L167",target:"_blank",rel:"noopener noreferrer"}},[t._v("事件代理机制"),s("OutboundLink")],1),t._v("中添加事务机制(调用"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/bdf263625db59f54368d39e8ef077e7f0e9313db/src/renderers/shared/stack/reconciler/ReactDefaultBatchingStrategy.js#L56",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactDefaultBatchingStrategy.batchedUpdates"),s("OutboundLink")],1),t._v(")")]),t._v(" "),s("li",[s("strong",[t._v("调用batchedUpdates")]),t._v(" 事务启动后,setState会将partial state存到组件实例_pendingStateQueue,再将其放入dirtyComponents数组中,等到事务结束时调用runBatchedUpdates批量更新")])]),t._v(" "),s("p",[s("strong",[t._v("A. 首先调用batchedUpdates的时候")])]),t._v(" "),s("ol",[s("li",[t._v("batchedUpdates会开启ReactDefaultBatchingStrategyTransaction批量处理事务")]),t._v(" "),s("li",[t._v("依次执行TransactionWrappers.initialize方法(这里都是emptyFunction)")]),t._v(" "),s("li",[t._v("执行传入的callback方法(callback方法中可能会执行setState)")]),t._v(" "),s("li",[t._v("依次执行传入的TransactionWrappers.close方法(先调用flushBatchedUpdates批量更新, 再结束本次batch)")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实例了一个事务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" transaction "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReactDefaultBatchingStrategyTransaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FLUSH_BATCHED_UPDATES")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  initialize"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" emptyFunction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  close"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ReactUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushBatchedUpdates")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ReactUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 批量更新")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RESET_BATCHED_UPDATES")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  initialize"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" emptyFunction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("close")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ReactDefaultBatchingStrategy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isBatchingUpdates "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结束本次batch")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TRANSACTION_WRAPPERS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FLUSH_BATCHED_UPDATES")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RESET_BATCHED_UPDATES")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 混合模式, 将批量更新机制注入事务机制")]),t._v("\nObject"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReactDefaultBatchingStrategyTransaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  Transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mixin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getTransactionWrappers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TRANSACTION_WRAPPERS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包括[FLUSH_BATCHED_UPDATES, RESET_BATCHED_UPDATES];")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" ReactDefaultBatchingStrategy "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  isBatchingUpdates"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事务标识锁")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("batchedUpdates")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" alreadyBatchingUpdates "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ReactDefaultBatchingStrategy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isBatchingUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ReactDefaultBatchingStrategy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isBatchingUpdates "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//开启一次事务")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("alreadyBatchingUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 说明事务已经开始,直接执行")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启动事务, 将callback放进事务里执行")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("perform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br")])]),s("p",[s("strong",[t._v("B. 在调用完batchedUpdates过程中调用setState")])]),t._v(" "),s("ol",[s("li",[t._v("调用enqueueSetState,拿到内部组件实例,将partial state存到实例的_pendingStateQueue属性中,然后调用enqueueUpdate")]),t._v(" "),s("li",[t._v("如果已经开启事务,就存储到dirtyCompents中")]),t._v(" "),s("li",[t._v("如果没开启事务,就开启事务,重新调用enqueueUpdate")]),t._v(" "),s("li",[t._v("无论哪个条件都没有立即更新")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReactComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("setState")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("partialState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updater"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueSetState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" partialState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updater"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setState'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("enqueueSetState")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("publicInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" partialState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据 this.setState 中的 this 拿到内部实例, 也就是组件实例")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" internalInstance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInternalInstanceReadyForUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("publicInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setState'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取得组件实例的_pendingStateQueue")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n      internalInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_pendingStateQueue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internalInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_pendingStateQueue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将partial state存到_pendingStateQueue")]),t._v("\n    queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("partialState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用enqueueUpdate")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internalInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueueUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("component")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensureInjected")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注入默认策略")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果没有开启batch(或当前batch已结束)就开启一次batch再执行, 这通常发生在异步回调中调用 setState      // 的情况")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("batchingStrategy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isBatchingUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    batchingStrategy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("batchedUpdates")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("enqueueUpdate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" component"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果batch已经开启就存储更新")]),t._v("\n  dirtyComponents"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("component"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("component"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_updateBatchNumber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    component"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_updateBatchNumber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" updateBatchNumber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br")])]),s("p",[s("strong",[t._v("C. close阶段批量更新")])]),t._v(" "),s("p",[t._v("首次渲染组件时调用事务的ABC总体流程")]),t._v(" "),s("img",{attrs:{src:t.$withBase("/framework/react_origin_transaction_mounted_process.png"),alt:"react_origin_transaction_mounted_process"}}),t._v(" "),s("ol",[s("li",[t._v("close阶段执行[FLUSH_BATCHED_UPDATES, RESET_BATCHED_UPDATES]")]),t._v(" "),s("li",[t._v("执行ReactUpdateFlushTransaction更新事务")]),t._v(" "),s("li",[t._v("执行perform,调用runBatchedUpdates")]),t._v(" "),s("li",[t._v("遍历dirtyComponents数组调用updateComponent进行更新")])]),t._v(" "),s("p",[s("strong",[t._v("D. setState调用时机")])]),t._v(" "),s("ol",[s("li",[t._v("constructor: 不会触发死循环,但会导致赋值失败,因为此时用于更新的_pandingStateQueue还未初始化,因此只能使用this.state赋值")]),t._v(" "),s("li",[t._v("componentWillMount&componentWillReciveProps: 不会触发死循环,会和原来的state合并")]),t._v(" "),s("li",[t._v("componentDidMount: 会重新触发一次渲染")]),t._v(" "),s("li",[t._v("coponentShouldUpdate,componentWillUpdate,render和componentDidUpdate: 会造成死循环")])])]),t._v(" "),s("h3",{attrs:{id:"架构缺陷"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#架构缺陷"}},[t._v("#")]),t._v(" 架构缺陷")]),t._v(" "),s("p",[t._v("虽然15版本实现了通过 "),s("strong",[t._v("batchedUpdates(批量更新)")]),t._v(" 将多个更新操作合并,但是单个更新在Reconciler递归diff组件的时候是同步的( "),s("strong",[t._v("Reconciler和Renderer是交替工作")]),t._v(" ),由于JS线程和GUI渲染线程是互斥的,如果长时间执行递归操作会导致页面刷新的延迟(16.6ms页面刷新频率),从而造成卡顿的现象")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Reconciler和Renderer交替工作")]),t._v(" "),s("p",[t._v("所谓交替工作是指Reconciler检测到dom节点的变化的时候会立即通知Renderer渲染器进行渲染")]),t._v(" "),s("div",{staticClass:"language-jsx line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-jsx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setCount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("App"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("button")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onClick")]),s("span",{pre:!0,attrs:{class:"token script language-javascript"}},[s("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("click to add count")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("button")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("lia"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("lib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n        ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("lic"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    ")]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("ol",[s("li",[t._v("点击button,触发useState更新")]),t._v(" "),s("li",[t._v("Reconciler检测lia的值变更为2, 立即通知Renderer更新DOM, 列表变成2,2,3")]),t._v(" "),s("li",[t._v("Reconciler检测lib的值变更为3, 立即通知Renderer更新DOM, 列表变成2,3,3")]),t._v(" "),s("li",[t._v("Reconciler检测lic的值变更为4, 立即通知Renderer更新DOM, 列表变成2,3,4")])])]),t._v(" "),s("h2",{attrs:{id:"react16"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react16"}},[t._v("#")]),t._v(" React16")]),t._v(" "),s("h3",{attrs:{id:"schedule-调度器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#schedule-调度器"}},[t._v("#")]),t._v(" Schedule(调度器)")]),t._v(" "),s("blockquote",[s("p",[t._v("调节任务的优先级,在合理的时间内中断和执行任务")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("调度流程")]),t._v(" "),s("ol",[s("li",[t._v("16版本通过启发式更新算法,根据用户不同的操作来指定任务的优先级,为每个任务分配各自的 "),s("strong",[t._v("expirationTime")]),t._v(".")]),t._v(" "),s("li",[t._v("在 "),s("strong",[t._v("requestIdleCallback")]),t._v(" (react自己编写了对应的垫片)规定的有效时间内执行任务,超过时间,将权限交给浏览器,跳过该次的事件循环")]),t._v(" "),s("li",[t._v("在过期时间内, 根据任务优先级来处理任务,如果新任务的优先级高, 可以打断低优先级任务,开始高优先级任务;  如果过期时间到期, 则马上执行该任务,无论优先级高低")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("expirationTime")]),t._v(" "),s("ol",[s("li",[t._v("我们可以粗略的归纳expirationTime的计算方式: msToExpirationTime(当前时间) + 优先级常量")]),t._v(" "),s("li",[t._v("msToExpirationTime用于表示一个时间范围间隔内取相同的值,相当于抹平了一段时间的差值,使的两个相近的任务在一次更新中完成")]),t._v(" "),s("li",[t._v("当前时间的计算方式: perfromance.now()")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("requestIdleCallback")]),t._v(" "),s("ol",[s("li",[t._v("原生的requestIdleCallback有两个问题: a.兼容性问题; b.每秒调用回调大约20次,不符合要求")]),t._v(" "),s("li",[t._v("用requestAnimationFrame和setTimeout(100ms)来定时调用任务")]),t._v(" "),s("li",[t._v("用当前时间和下一帧时间的大小来判断是否有空闲时间执行任务")]),t._v(" "),s("li",[t._v("通过MessageChannel在宏任务时间段执行任务")])])]),t._v(" "),s("h3",{attrs:{id:"reconciler-协调器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器"}},[t._v("#")]),t._v(" Reconciler(协调器)")]),t._v(" "),s("blockquote",[s("p",[t._v("通过Fiber架构和Schedule机制实现组件更新挂载任务,避免了Reconciler和Render交替执行的时间占用过大")])]),t._v(" "),s("p",[t._v("Reconciler在Fiber架构下分成两个阶段")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("调度渲染阶段(reconciliation)\n在render|setState|forceUpdate触发,通过启发式diff算法找出需要更新的节点,并打上标记(我们称之为副作用effect),该阶段可以被中断")])]),t._v(" "),s("li",[s("p",[t._v("diff对比找出Fiber节点需要更新的部分,生成新的Fiber树并保存EffectList")])]),t._v(" "),s("li",[s("p",[t._v("计算任务的expriationTime(当前时间点 + 优先级常量)")]),t._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberScheduler.js#L1948",target:"_blank",rel:"noopener noreferrer"}},[t._v("获取当前渲染时间点(终点常量时间 - 渲染经历时间)"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("获取当前任务的"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/scheduler/src/Scheduler.js#L433",target:"_blank",rel:"noopener noreferrer"}},[t._v("优先级(同步, 交互, 异步, 空闲)"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("根据当前时间点和优先级常量获取过期时间,并通过"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberExpirationTime.js#L31",target:"_blank",rel:"noopener noreferrer"}},[t._v("ceiling函数"),s("OutboundLink")],1),t._v("抹平了一段时间的时间差,优化了渲染性能")])])]),t._v(" "),s("li",[s("p",[t._v("创建任务的Update, 并推入"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactUpdateQueue.js#L220",target:"_blank",rel:"noopener noreferrer"}},[t._v("UpdateQueue"),s("OutboundLink")],1),t._v("中")]),t._v(" "),s("ol",[s("li",[t._v("updateQueue分为current queue(queue1)、work-in-progress queue(queue2) 两个队列")]),t._v(" "),s("li",[t._v("如果两者均为null，则调用createUpdateQueue()获取初始队列")]),t._v(" "),s("li",[t._v("如果两者之一为null，则调用cloneUpdateQueue()从对方中获取队列")]),t._v(" "),s("li",[t._v("如果两者均不为null，则将update作为lastUpdate")])])]),t._v(" "),s("li",[s("p",[t._v("如果使用了useEffect(在早期16版本中没有)")]),t._v(" "),s("ol",[s("li",[t._v("调用该useEffect在上一次render时的销毁函数")]),t._v(" "),s("li",[t._v("调用该useEffect在本次render时的回调函数")])])]),t._v(" "),s("li",[s("p",[t._v("开启ScheduleWork调度, 遇到超时或者有更高优先级任务时会挂起退出")])]),t._v(" "),s("li",[s("p",[t._v("每次调度之前,判断当前任务是否过期, 过期就直接调用port.postMessage(undefined),会在下次渲染之前执行任务")])]),t._v(" "),s("li",[s("p",[t._v("没有过期,就调用RequestAnimationFrame,让任务在重绘前调用")])]),t._v(" "),s("li",[s("p",[t._v("有些任务被打断并恢复执行时,会造成一些生命周期被多次调用, 不要在这些生命周期执行一些带有副作用的操作(包括操作dom, setState和调用Ajax)")]),t._v(" "),s("ol",[s("li",[t._v("constructor")]),t._v(" "),s("li",[t._v("componentWillMount,")]),t._v(" "),s("li",[t._v("componentWillReceiveProps,")]),t._v(" "),s("li",[t._v("static getDerivedStateFromProps")]),t._v(" "),s("li",[t._v("shouldComponentUpdate,")]),t._v(" "),s("li",[t._v("componentWillUpdate,")]),t._v(" "),s("li",[t._v("render")])])]),t._v(" "),s("li",[s("p",[t._v("该阶段对于用户是没有副作用(DOM更新等)的")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Schedule Work")]),t._v(" "),s("p",[t._v("前期版本")]),t._v(" "),s("ol",[s("li",[t._v("找到FiberRoot并返回,同时设置节点的expirationTime和childExpirationTime为该update的expirationTime(如果这两个属性的时间小于update的时间)")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberScheduler.js#L1873",target:"_blank",rel:"noopener noreferrer"}},[t._v("如果新任务优先级高,会打断之前的任务"),s("OutboundLink")],1),t._v(" "),s("ol",[s("li",[t._v("没有任务执行(调度交给了浏览器)")]),t._v(" "),s("li",[t._v("存在任务未执行完成(比如异步任务)")]),t._v(" "),s("li",[t._v("新任务的过期时间小于之前的任务")])])]),t._v(" "),s("li",[t._v("如果不是render阶段或者FiberRoot不一致就会通过requestWork调度任务\n"),s("ol",[s("li",[t._v("将当前的root加入到ScheduleRoot的单向循环链表\n"),s("ol",[s("li",[t._v("通过root.nextScheduledRoot判断当前的root是否已经进入调度阶段")]),t._v(" "),s("li",[t._v("root.nextScheduledRoot == null 表示还没有进入调度\n"),s("ol",[s("li",[t._v("如果lastScheduledRoot不存在,说明当前没有要处理的root, 这时候就把 firstScheduleRoot、lastScheduleRoot、root.nextScheduleRoot都赋值为root "),s("strong",[t._v("(形成首尾相连的单向循环链表 A->A)")])]),t._v(" "),s("li",[t._v("如果lastScheduledRoot存在,就把当前root插入到ScheduleRoot链表末尾 "),s("strong",[t._v("(A->B->A)")])])])]),t._v(" "),s("li",[t._v("root.nextScheduledRoot != null 表示已经进入了调度, 并设置当前root的最高优先级")])])]),t._v(" "),s("li",[t._v("判断三个环境\n"),s("ol",[s("li",[t._v("如果已经在render的过程中,会直接返回")]),t._v(" "),s("li",[t._v("如果是已经开始批处理\n"),s("ol",[s("li",[t._v("是首次渲染,会调用performWorkOnRoot立即更新")]),t._v(" "),s("li",[t._v("不是首次渲染,也会直接返回")])])]),t._v(" "),s("li",[t._v("当expirationTime为同步的时候,会调用performSyncWork立即执行(这种情况相对常见)")]),t._v(" "),s("li",[t._v("其余的走scheduleCallbackWithExpirationTime调度(该函数可以看成requestIdleCallback的polyfill版本)\n"),s("ol",[s("li",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberScheduler.js#L1966",target:"_blank",rel:"noopener noreferrer"}},[t._v("调用cancelDeferredCallBack取消之前的任务"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("计算timeout(当前的任务的延迟过期时间),"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/scheduler/src/Scheduler.js#L317",target:"_blank",rel:"noopener noreferrer"}},[t._v("执行scheduleDeferredCallback"),s("OutboundLink")],1)])])])])])])])])]),t._v(" "),s("ol",{attrs:{start:"11"}},[s("li",[t._v("提交更新阶段(commit): 将调度阶段需要处理的副作用一次性执行,该阶段不可调度不可中断\n该阶段是将调度阶段生成的effectList应用到真实节点中")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("UpdateQueue")]),t._v(" "),s("p",[t._v("在16中UpdateQueue是单向链表,在17中UpdateQueue变成了单向循环链表")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("如何在Reconciler层中断任务")]),t._v(" "),s("p",[t._v("将原来的递归调用改成了while循环,关键是shouldYield这个函数判断了剩余可执行时间")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("workLoopConcurrent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldYield")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    workInProgress "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("performUnitOfWork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("FiberNode")]),t._v(" "),s("p",[t._v("FiberNode在原有的虚拟dom结构上增加的多种属性,同时修改了将原有的树形结构改成了链表结构")]),t._v(" "),s("ol",[s("li",[t._v("用于表示 "),s("strong",[t._v("链表结构属性")]),t._v(",如return,child. sibling")]),t._v(" "),s("li",[t._v("用于原来的React Element的 "),s("strong",[t._v("静态数据结构")]),t._v(" ,保存了组件DOM信息,如tag,type,stateNode")]),t._v(" "),s("li",[t._v("用于保存需要更新的 "),s("strong",[t._v("动态的工作单元")]),t._v(",如pendingProps, effectTag")])])]),t._v(" "),s("h3",{attrs:{id:"render-渲染器-执行最终的渲染"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#render-渲染器-执行最终的渲染"}},[t._v("#")]),t._v(" Render(渲染器): 执行最终的渲染")]),t._v(" "),s("h2",{attrs:{id:"react17"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react17"}},[t._v("#")]),t._v(" React17")])])}),[],!1,null,null,null);a.default=e.exports}}]);